<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel - Master the Impulse MVP</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for a nice font and colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo
                        'secondary': '#f97316', // Orange
                        'success': '#10b981', // Emerald
                        'danger': '#ef4444', // Red
                        'bg-dark': '#0f172a', // Slate-900 (Main BG)
                        'bg-card': '#1e293b', // Slate-800 (Card BG)
                        'text-light': '#f1f5f9', // Slate-100 (Primary Text)
                        'accent-dark': '#334155', // Slate-700 for input backgrounds
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for dark mode and main layout */
        body {
            background-color: #0f172a; /* bg-dark */
            color: #f1f5f9; /* text-light */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        /* Main app container on large screens */
        #app-container {
            max-width: 600px; 
            width: 100%;
        }
        
        /* Typography adjustments for better readability */
        h1, h2, h3 {
            letter-spacing: -0.025em; /* Tighten headers slightly */
        }
        h1 { font-size: 2.25rem; }
        h2 { font-size: 1.5rem; }

        /* Global Card Styling with subtle animations */
        .app-card {
            background-color: #1e293b; /* bg-card */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 0 10px rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            transition: all 0.2s ease-in-out;
        }
        .app-card:hover:not(.no-hover) {
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.3), 0 0 15px rgba(79, 70, 229, 0.4);
        }

        /* Custom form input styles */
        input[type="text"], input[type="number"], input[type="tel"], textarea, select {
            background-color: #334155 !important; /* accent-dark */
            border-color: #475569 !important; /* slate-600 */
            color: #f1f5f9 !important;
            padding: 0.75rem !important; /* Increased padding */
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus:not(:disabled), input[type="number"]:focus:not(:disabled), input[type="tel"]:focus:not(:disabled), textarea:focus:not(:disabled), select:focus:not(:disabled) {
            border-color: #4f46e5 !important; /* primary focus */
            box-shadow: 0 0 0 1px #4f46e5;
        }
        input[type="date"] {
            color-scheme: dark;
        }
        
        /* Disabled Input Visual Fix */
        input:disabled, textarea:disabled, select:disabled {
            background-color: #1e293b !important; /* bg-card for disabled state */
            border-color: #334155 !important;
            color: #94a3b8 !important; /* slate-400 */
        }


        /* Progress Bar */
        .progress-bar-container {
            height: 1.5rem;
            background-color: #334155;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Buttons - Improved hover/active states */
        .btn {
             transition: all 0.2s ease-in-out, box-shadow 0.2s;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             font-weight: 600;
             padding: 0.6rem 1rem;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
        }

        /* Radio/Rating Inputs */
        .rating-input + label {
            padding: 0.75rem 0.5rem; 
            font-size: 0.7rem; 
            line-height: 1.1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            word-break: break-word;
            border-radius: 0.5rem;
            border: 1px solid #475569;
        }
        @media (min-width: 640px) {
            .rating-input + label {
                padding: 0.75rem 1rem;
                font-size: 0.875rem; 
            }
        }
        .rating-input:checked + label { background-color: #f97316; color: white; border-color: #f97316; transform: scale(1.02); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4); }
        .radio-group-error { border: 2px solid #ef4444; padding: 8px; border-radius: 0.5rem; }

        /* Log History Entries */
        .log-entry { border-left: 4px solid; padding: 12px; margin-bottom: 8px; border-radius: 0.5rem; transition: all 0.2s; }
        .log-entry:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .proof-icon { font-size: 2rem; line-height: 1; padding: 4px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.1); }

        /* Modal & Battle Arena */
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            justify-content: center; 
            /* CRITICAL FIX: Align content to start to ensure tall modals don't overflow the top */
            align-items: flex-start; 
            z-index: 2000; 
            padding: 1rem;
            overflow-y: auto; /* Allows scrolling if modal content is taller than viewport */
        }
        
        /* New: Proof Modal Content Constraint */
        .proof-modal-content {
            max-height: 95vh; /* Max height is 95% of viewport height */
            overflow-y: auto; /* Allows content inside the modal to scroll */
            margin-top: 1rem; /* Add top margin when aligned to flex-start */
            margin-bottom: 1rem;
        }
        
        /* CRITICAL FIX: Constrain media elements within the proof preview */
        #proof-preview img, #proof-preview video, #proof-preview audio {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 0.5rem;
            object-fit: contain; /* Ensure video/image fits without cropping */
        }
        

        #arena-log { height: 100px; max-height: 100px; }
        .battle-card:hover { transform: translateY(-2px); box-shadow: 8px 12px rgba(79, 70, 229, 0.3); }
        .battle-active { border-color: #f97316 !important; box-shadow: 0 0 15px rgba(249, 115, 22, 0.5); }
        
        /* Mobile adjustments for navigation (CRITICAL FIX) */
        #dashboard-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px; /* Increased gap */
            padding: 10px;
        }
        #dashboard-nav button {
            font-size: 0.7rem; /* Slightly larger font */
            padding: 10px 4px; /* Increased padding for better tap targets */
            line-height: 1; /* Ensure text fits */
            height: auto; /* Allow button height to adjust */
        }
        @media (min-width: 640px) {
            #dashboard-nav button {
                font-size: 0.875rem;
                padding: 10px 8px;
            }
        }
        
        /* Responsive Avatar/Stats Panel - Mobile stacking behavior */
        #dashboard-display .flex {
            flex-direction: column;
        }
        #avatar-container {
            width: 100%;
        }
        #stats-panel {
            width: 100%;
            padding-top: 1rem;
            border-top: 1px solid #334155;
            margin-top: 1rem;
        }
        @media (min-width: 640px) {
            #dashboard-display .flex {
                flex-direction: row;
            }
            #avatar-container {
                width: 33.3333%;
            }
            #stats-panel {
                width: 66.6666%;
                padding-top: 0;
                border-top: none;
                margin-top: 0;
            }
        }
        
        /* FIX: Splash screen full screen overlay */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f172a; /* Match body BG */
            z-index: 3000; /* Ensure it's on top of everything */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }
        #splash-screen.hidden-init {
             display: none; /* Hide instantly on page load */
        }
        #splash-screen.fade-out {
            opacity: 0;
        }

    </style>
</head>
<body class="hidden-init"> <!-- HIDE body until splash is done -->

    <!-- General Purpose Custom Modal -->
    <div id="general-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-sm border border-secondary/50 text-center proof-modal-content">
            <h3 id="general-modal-title" class="text-2xl font-bold text-primary mb-3"></h3>
            <p id="general-modal-message" class="text-text-light mb-5"></p>
            <button onclick="closeGeneralModal()" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                Acknowledge
            </button>
        </div>
    </div>

    <!-- Proof Submission Modal (Hidden by Default) -->
    <div id="proof-modal" class="modal-backdrop hidden">
        <!-- CRITICAL FIX: Added proof-modal-content class for max-height and internal scrolling -->
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-sm border border-primary/50 proof-modal-content">
            <h3 class="text-xl font-bold text-secondary mb-2">Quest Proof Submission</h3>
            
            <form id="proof-form" class="space-y-4">
                <input type="hidden" id="proof-task-id">
                <input type="hidden" id="proof-battle-id">
                
                <!-- Task Info -->
                <div class="p-3 bg-slate-800 rounded-lg border border-primary/50">
                    <p class="text-lg font-medium text-text-light" id="proof-task-name"></p>
                    <p class="text-sm text-success" id="proof-power-reward"></p>
                </div>
                
                <!-- Proof Type Selector (NEW) -->
                <label for="proof-type-select" class="block text-sm font-medium text-text-light">Select Proof Type:</label>
                <select id="proof-type-select" required onchange="handleProofTypeChange(this.value)" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                    <option value="">Choose Proof Type...</option>
                    <option value="file">📸 Media (Image, Video, Audio)</option>
                    <option value="text">📝 Written Proof (Journal Entry)</option>
                </select>

                <!-- Proof Upload and Preview (File Type) -->
                <div id="file-proof-container" class="space-y-4 hidden">
                    <!-- CRITICAL FIX: The preview needs a constrained container for uploaded media -->
                    <div id="proof-preview" class="p-2 bg-slate-800 rounded-lg max-h-40 overflow-hidden text-center text-sm text-slate-400">
                        Upload your file...
                    </div>
                    
                    <label for="proof-file" class="block text-sm font-medium text-text-light">Upload File (Image, Video, Audio):</label>
                    <input type="file" id="proof-file" accept="image/*,video/*,audio/*" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/20 file:text-primary hover:file:bg-primary/30" onchange="previewProofImage(event)">
                </div>

                <!-- Text Proof Area -->
                <div id="text-proof-container" class="space-y-4 hidden">
                    <label for="proof-text" class="block text-sm font-medium text-text-light">Write Text Proof (e.g., Journal Entry):</label>
                    <textarea id="proof-text" rows="2" placeholder="Write a short summary of task completion..." class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 text-text-light"></textarea>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" onclick="closeProofModal()" class="btn bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="btn bg-success hover:bg-success/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                        Confirm & Gain Power
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New: Turn-Based Battle Modal (Impulse Battle Arena) -->
    <div id="battle-arena-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-lg border border-secondary/50 text-center space-y-4 proof-modal-content">
            <h3 class="text-2xl font-bold text-primary mb-2">Impulse Battle Arena</h3>
            
            <!-- Battle Log / Status -->
            <div id="arena-log" class="text-sm bg-slate-800 p-3 rounded-lg text-left h-20 overflow-y-auto">
                <p class="text-slate-400">Battle Starting...</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 items-center">
                
                <!-- Monster Side -->
                <div class="space-y-1">
                    <div id="arena-monster-emoji" class="text-5xl"></div>
                    <p id="arena-monster-name" class="font-bold text-lg text-danger"></p>
                    <div class="progress-bar-container h-4">
                        <div id="arena-monster-hp-bar" class="progress-bar bg-danger transition-all" style="width: 100%;"></div>
                    </div>
                    <p id="arena-monster-hp-text" class="text-xs text-danger"></p>
                </div>

                <!-- Player Side -->
                <div class="space-y-1">
                    <div id="arena-player-emoji" class="text-5xl">🥷</div>
                    <p id="arena-player-name" class="font-bold text-lg text-primary"></p>
                    <div class="progress-bar-container h-4">
                        <div id="arena-player-hp-bar" class="progress-bar bg-primary transition-all" style="width: 100%;"></div>
                    </div>
                    <p id="arena-player-hp-text" class="text-xs text-primary"></p>
                </div>

            </div>

            <!-- Controls -->
            <div id="arena-controls" class="space-y-3">
                <p id="arena-message" class="text-sm text-yellow-400 font-semibold"></p>
                <div class="grid grid-cols-2 gap-3">
                    <button id="arena-attack-btn" onclick="playerTurn('Attack')" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 rounded-xl">
                        Focus Attack!
                    </button>
                    <button id="arena-defend-btn" onclick="playerTurn('Defend')" class="btn bg-primary hover:bg-primary/90 text-white font-semibold py-3 rounded-xl">
                        Willpower Defend!
                    </button>
                    <button id="arena-skill-1" onclick="playerTurn('Skill1')" class="btn skill-card text-white font-semibold py-3 rounded-xl text-sm opacity-50" disabled>
                        (Skill Slot 1)
                    </button>
                    <button id="arena-skill-2" onclick="playerTurn('Skill2')" class="btn skill-card text-white font-semibold py-3 rounded-xl text-sm opacity-50" disabled>
                        (Skill Slot 2)
                    </button>
                </div>
                <button id="arena-run-btn" onclick="endBattle(false)" class="btn bg-slate-600 hover:bg-slate-500 text-white py-2 px-4 rounded-xl text-sm w-full">
                    Retreat (Loss)
                </button>
            </div>
        </div>
    </div>


    <!-- Splash Screen (Now fixed position, hidden initially by CSS) -->
    <div id="splash-screen" class="hidden-init">
        <div class="text-center">
            <h1 class="text-6xl font-extrabold text-primary splash-text" style="animation-delay: 0.2s;">SENTINEL</h1>
            <p class="text-2xl text-secondary mt-2 splash-text" style="animation-delay: 0.7s;">Master the Impulse. MVP</p>
            <p class="text-sm text-slate-400 mt-6 splash-text" style="animation-delay: 1.2s;">Loading your battlefield...</p>
        </div>
    </div>


    <!-- Main Application Container (Now hidden by body style until load) -->
    <div id="app-container" class="w-full max-w-xl mx-auto bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-primary/50 space-y-6">

        <header class="text-center pb-4 border-b border-primary/30">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-primary">SENTINEL <span class="text-secondary">Master the Impulse. MVP</span></h1>
        </header>

        <!-- 0. Character Creation Section (Shown first time) -->
        <div id="character-creation-section" class="space-y-4 p-4 app-card hidden">
            <h2 id="creation-title" class="text-xl font-bold mb-3 text-secondary"></h2>
            <p id="creation-subtitle" class="text-sm text-slate-400"></p>
            
            <form id="character-form" class="space-y-4">
                <input type="hidden" id="current-step" value="1">

                <!-- STEP 1: YOUR IDENTITY (Updated Fields) -->
                <div id="step-1" class="space-y-4">
                    <label for="char-real-name" class="block text-sm font-medium text-text-light">Real Name (Private):</label>
                    <input type="text" id="char-real-name" placeholder="Your real name" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">

                    <label for="char-name" class="block text-sm font-medium text-text-light">Warrior Alias (Public/Game Name):</label>
                    <input type="text" id="char-name" placeholder="e.g., 'Sentinel' or your chosen alias" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="char-age" class="block text-sm font-medium text-text-light">Age:</label>
                            <input type="number" id="char-age" placeholder="Age" min="15" max="100" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        </div>
                        <div>
                            <label for="char-city" class="block text-sm font-medium text-text-light">City/Location:</label>
                            <input type="text" id="char-city" placeholder="Your City" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        </div>
                    </div>
                    
                    <label for="char-phone" class="block text-sm font-medium text-text-light">Phone Number (Private):</label>
                    <!-- FIX: Added oninput to ensure only digits remain, handling pastes and non-numeric input -->
                    <input type="tel" id="char-phone" placeholder="e.g., 9876543210" required pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">

                    <label for="char-source" class="block text-sm font-medium text-text-light">How did you find us?</label>
                    <input type="text" id="char-source" placeholder="e.g., Friend, Ad, Search" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">

                    <div class="border-t border-slate-600 pt-3">
                         <label for="char-faith" class="block text-sm font-medium text-text-light">Faith/Belief System?</label>
                         <select id="char-faith" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                             <option value="no">No</option>
                             <option value="yes">Yes</option>
                         </select>
                    </div>
                </div>

                <!-- STEP 2: THE BATTLEFIELD (Addiction Details + Willpower/Focus) -->
                <div id="step-2" class="space-y-4 hidden">
                    
                    <label class="block text-sm font-medium pt-2 text-text-light">Core Stat Rating: How strong is your Willpower?</label>
                    <div class="flex justify-between text-xs text-slate-400"><span>1 (Weak)</span><span>10 (Unshakeable)</span></div>
                    <input type="range" id="char-willpower" min="1" max="10" value="5" required oninput="this.nextElementSibling.value=this.value" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer range-lg">
                    <output class="block text-center text-lg font-bold text-primary">5</output>

                    <label class="block text-sm font-medium pt-2 text-text-light border-t border-slate-600 pt-3">Core Stat Rating: How sharp is your Focus?</label>
                    <div class="flex justify-between text-xs text-slate-400"><span>1 (Distracted)</span><span>10 (Laser Focus)</span></div>
                    <input type="range" id="char-focus" min="1" max="10" value="5" required oninput="this.nextElementSibling.value=this.value" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer range-lg">
                    <output class="block text-center text-lg font-bold text-primary">5</output>

                    <p class="text-sm font-medium pt-2 text-text-light border-t border-slate-600 pt-3">How deep is the conflict? (Addiction Level)</p>
                    <div id="addiction-group" class="grid grid-cols-3 gap-2">
                        <input type="radio" id="addiction-mild" name="char-addiction" value="mild" required class="hidden rating-input">
                        <label for="addiction-mild" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Mild</label>
                        <input type="radio" id="addiction-moderate" name="char-addiction" value="moderate" class="hidden rating-input">
                        <label for="addiction-moderate" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Moderate</label>
                        <input type="radio" id="addiction-severe" name="char-addiction" value="severe" class="hidden rating-input">
                        <label for="addiction-severe" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Severe</label>
                    </div>
                    
                    <label for="char-frequency" class="block text-sm font-medium text-text-light">How often do you experience urges or exposure?</label>
                    <select id="char-frequency" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        <option value="">Select frequency...</option>
                        <option value="daily">Daily</option>
                        <option value="several-week">Several times per week</option>
                        <option value="weekly">Weekly</option>
                        <option value="less">Less than Weekly</option>
                    </select>

                    <label for="char-quit-count" class="block text-sm font-medium text-text-light">Times tried to quit before:</label>
                    <select id="char-quit-count" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        <option value="0">0 (First Attempt)</option>
                        <option value="1">1 to 3 Times</option>
                        <option value="4">4 to 7 Times</option>
                        <option value="8">8+ Times</option>
                    </select>

                    <p class="text-sm font-medium text-text-light">Does usage interfere with your daily life (work/relationships)?</p>
                    <div id="interfere-group" class="grid grid-cols-2 gap-3">
                        <input type="radio" id="interfere-yes" name="char-interfere" value="yes" required class="hidden rating-input">
                        <label for="interfere-yes" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer">Yes</label>
                        <input type="radio" id="interfere-no" name="char-interfere" value="no" class="hidden rating-input">
                        <label for="interfere-no" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer">No</label>
                    </div>
                    
                    <p class="text-sm font-medium text-text-light">Level of Guilt/Shame felt after use:</p>
                    <div id="guilt-group" class="grid grid-cols-5 gap-1">
                        <input type="radio" id="guilt-1" name="char-guilt-shame" value="1" required class="hidden rating-input">
                        <label for="guilt-1" class="p-2 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-xs">None</label>
                        <input type="radio" id="guilt-2" name="char-guilt-shame" value="2" class="hidden rating-input">
                        <label for="guilt-2" class="p-2 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-xs">Low</label>
                        <input type="radio" id="guilt-3" name="char-guilt-shame" value="3" class="hidden rating-input">
                        <label for="guilt-3" class="p-2 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-xs">Moderate</label>
                        <input type="radio" id="guilt-4" name="char-guilt-shame" value="4" class="hidden rating-input">
                        <label for="guilt-4" class="p-2 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-xs">High</label>
                        <input type="radio" id="guilt-5" name="char-guilt-shame" value="5" class="hidden rating-input">
                        <label for="guilt-5" class="p-2 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-xs">Crippling</label>
                    </div>
                </div>

                <!-- STEP 3: THE ENEMY WITHIN (Triggers & Resources) -->
                <div id="step-3" class="space-y-4 hidden">
                    <p class="text-sm font-medium text-text-light">Select your most frequent Triggers - check all that apply:</p>
                    <div class="space-y-2 bg-slate-600 p-3 rounded-lg border border-slate-500">
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="alone"><span>👤 Being alone / Isolation</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="boredom"><span>😴 Boredom / Idleness</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="stress"><span>😟 Stress / Anxiety / Anger</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="night"><span>🌙 Late at night / Fatigue</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="media"><span>📱 Social media / Phone usage</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-trigger" value="fantasy"><span>💭 Visual content / Fantasy</span></label>
                    </div>

                    <p class="text-sm font-medium text-text-light">Support System: How strong is your network?</p>
                    <div id="support-group" class="grid grid-cols-3 gap-2">
                        <input type="radio" id="support-weak" name="char-support" value="weak" required class="hidden rating-input">
                        <label for="support-weak" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Weak/None</label>
                        <input type="radio" id="support-moderate" name="char-support" value="moderate" class="hidden rating-input">
                        <label for="support-moderate" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Moderate</label>
                        <input type="radio" id="support-strong" name="char-support" value="strong" required class="hidden rating-input">
                        <label for="support-strong" class="p-3 text-center rounded-lg bg-slate-600 hover:bg-slate-500 border border-slate-500 transition cursor-pointer text-sm">Strong/Active</label>
                    </div>

                    <label for="char-time-since" class="block text-sm font-medium text-text-light">Time Since Last Urge or Relapse:</label>
                    <select id="char-time-since" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        <option value="">Select timeframe...</option>
                        <option value="hours">Hours ago</option>
                        <option value="days">Few days (1-7)</option>
                        <option value="weeks">Few weeks (7+ days)</option>
                        <option value="months">Months or more</option>
                    </select>
                </div>

                <!-- STEP 4: THE HERO'S OATH (Motivation & Goals) -->
                <div id="step-4" class="space-y-4 hidden">
                    <p class="text-sm font-medium text-text-light">Why do you seek strength? (Motivation) - check all that apply:</p>
                    <div class="space-y-2 bg-slate-600 p-3 rounded-lg border border-slate-500">
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-motive" value="relationships"><span>🤝 Improve relationships</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-motive" value="peace"><span>🧘 Mental peace / Less anxiety</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-motive" value="productivity"><span>⚙️ Productivity / Focus</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-motive" value="self-respect"><span>🛡️ Self-respect / Integrity</span></label>
                        <label class="flex items-center space-x-2 text-sm text-text-light"><input type="checkbox" name="char-motive" value="faith"><span>✨ Faith / Spiritual reasons</span></label>
                    </div>
                    
                    <label for="char-purpose" class="block text-sm font-medium text-text-light">Your immediate quest goal:</label>
                    <textarea id="char-purpose" rows="3" placeholder="e.g., '1 week clean', 'Meditate daily'" required class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 focus:ring-secondary focus:border-secondary transition duration-150 text-text-light"></textarea>

                </div>

                <!-- NAVIGATION BUTTONS -->
                <div class="flex justify-between pt-4 border-t border-slate-600">
                    <button type="button" id="prev-btn" class="btn bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 opacity-50 cursor-not-allowed" disabled onclick="navigateStep(-1)">
                        <span class="mr-2">⬅️</span> Back
                    </button>
                    <button type="button" id="next-btn" class="btn bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200" onclick="navigateStep(1)">
                        Next Step <span class="ml-2">➡️</span>
                    </button>
                    <button type="submit" id="submit-btn" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 hidden">
                        Finalize Character & Begin!
                    </button>
                </div>
            </form>
        </div>


        <!-- 1. Trigger Input Section -->
        <div id="trigger-section" class="hidden space-y-6">
            
            <!-- Dashboard Stats and Avatar (Top Panel) -->
            <div id="dashboard-display" class="p-4 app-card shadow-lg">
                <h3 class="text-xl font-bold text-text-light mb-3 border-b border-slate-600 pb-2">Your Sentinel</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <!-- Avatar (Left) -->
                    <div id="avatar-container" class="w-full sm:w-1/3 flex flex-col items-center justify-center p-3 bg-slate-800 rounded-lg border border-primary/30">
                        <!-- Avatar content injected here -->
                    </div>
                    <!-- Stats Panel (Right) -->
                    <div id="stats-panel" class="w-full sm:w-2/3 space-y-2 p-2">
                        <!-- Stats content injected here -->
                    </div>
                </div>
            </div>

            <!-- Dashboard Navigation Buttons (UPDATED - Responsive fix) -->
            <div id="dashboard-nav" class="app-card shadow-lg">
                <button 
                    id="nav-log" 
                    class="btn bg-primary text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('log')">
                    📝 Log
                </button>
                <button 
                    id="nav-battle" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('battle')">
                    ⚔️ Battles
                </button>
                <button 
                    id="nav-skills" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('skills')">
                    🧠 Skills
                </button>
                <button 
                    id="nav-guide" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('guide')">
                    ❓ Guide
                </button>
                <button 
                    id="nav-settings" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('settings')">
                    ⚙️ Settings
                </button>
            </div>


            <!-- Main Content Area -->
            <div id="main-dashboard-content" class="space-y-6">

                <!-- LOG & HISTORY VIEW (Default View) -->
                <div id="log-view-container">
                    
                    <!-- Impulse Log Form -->
                    <form id="trigger-form" class="space-y-4 p-4 app-card shadow-lg">
                        <h3 class="text-xl font-bold text-secondary mb-3">Impulse Log</h3>
                        
                        <label for="log-date" class="block text-sm font-medium text-text-light">Date of Encounter:</label>
                        <input type="date" id="log-date" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label for="trigger-type" class="block text-sm font-medium text-text-light">Core Trigger Category:</label>
                                <select id="trigger-type" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                                    <option value="">Select Category...</option>
                                    <option value="Loneliness">👤 Loneliness/Isolation</option>
                                    <option value="Boredom">😴 Boredom/Idleness</option>
                                    <option value="Stress/Anxiety">😟 Stress/Anxiety</option>
                                    <option value="Late Night Urge">🌙 Late Night Urge</option>
                                    <option value="Media/Phone Triggers">📱 Media/Phone Triggers</option>
                                    <option value="Curiosity">🧐 Curiosity/Just Checking</option>
                                    <option value="Rejection/Failure">💔 Rejection/Failure</option>
                                    <option value="Fatigue">😩 Fatigue</option>
                                </select>
                            </div>
                            <div>
                                <label for="log-time" class="block text-sm font-medium text-text-light">Time of Day:</label>
                                <select id="log-time" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                                    <option value="">Select Time...</option>
                                    <option value="Morning">☀️ Morning (5 AM - 12 PM)</option>
                                    <option value="Afternoon">🌤️ Afternoon (12 PM - 5 PM)</option>
                                    <option value="Evening">🌇 Evening (5 PM - 9 PM)</option>
                                    <option value="Night">🌙 Night (9 PM - 5 AM)</option>
                                </select>
                            </div>
                        </div>

                        <label for="trigger-specific" class="block text-sm font-medium text-text-light">Specific Trigger Event:</label>
                        <textarea id="trigger-specific" rows="2" placeholder="Describe the specific event: e.g., 'Got laid off and immediately grabbed my phone.' or 'Scrolling Instagram led to an urge.'" required class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 focus:ring-secondary focus:border-secondary transition duration-150 text-text-light"></textarea>

                        <label for="log-emotion" class="block text-sm font-medium text-text-light">Primary Emotion Felt:</label>
                        <select id="log-emotion" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                            <option value="">Select Emotion...</option>
                            <option value="Loneliness">Loneliness</option>
                            <option value="Anxiety">Anxiety</option>
                            <option value="Anger">Anger/Frustration</option>
                            <option value="Sadness">Sadness/Depression</option>
                            <option value="Boredom">Boredom</option>
                            <option value="Fatigue">Physical Fatigue</option>
                            <option value="Overconfidence">Overconfidence</option>
                        </select>

                        <label for="log-thoughts" class="block text-sm font-medium text-text-light">Thoughts/Rationalizations During the Urge:</label>
                        <textarea id="log-thoughts" rows="2" placeholder="e.g., 'This is just one time', 'I deserve a break'" class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 text-text-light"></textarea>

                        <p class="text-sm font-medium text-text-light">Action Taken:</p>
                        <div id="action-taken-group" class="grid grid-cols-3 gap-2">
                            <input type="radio" id="action-resisted" name="log-action" value="Resisted" required class="hidden rating-input">
                            <label for="action-resisted" class="p-3 text-center rounded-lg bg-success hover:bg-success/80 border border-success transition cursor-pointer text-sm">Resisted</label>
                            
                            <input type="radio" id="action-delayed" name="log-action" value="Delayed" class="hidden rating-input">
                            <label for="action-delayed" class="p-3 text-center rounded-lg bg-yellow-500 hover:bg-yellow-500/80 border border-yellow-500 transition cursor-pointer text-sm">Delayed</label>
                            
                            <input type="radio" id="action-gavein" name="log-action" value="Gave In" class="hidden rating-input">
                            <label for="action-gavein" class="p-3 text-center rounded-lg bg-danger hover:bg-danger/80 border border-danger transition cursor-pointer text-sm">Gave In</label>
                        </div>

                        <!-- Conditional Field: Shown only if 'Gave In' -->
                        <div id="gave-in-fields" class="space-y-4 p-3 bg-slate-800 rounded-lg hidden">
                            <label for="log-after-feelings" class="block text-sm font-medium text-text-light">If Gave In: How Did You Feel After?</label>
                            <textarea id="log-after-feelings" rows="2" placeholder="e.g., 'Shameful, tired, and guilty'" class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 text-text-light"></textarea>
                        </div>
                        
                        <div id="resisted-fields">
                            <label for="log-tried-instead" class="block text-sm font-medium text-text-light">What Positive Action Did You Try Instead? (Required if Resisted/Delayed):</label>
                            <select id="log-tried-instead" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light">
                                <option value="">Select Action...</option>
                                <option value="Exercise">🏋️ Physical Exercise (Pushups, Run)</option>
                                <option value="Contact">🤝 Contact Support (Friend, Mentor)</option>
                                <option value="Meditation">🧘 Meditation/Prayer/Breathing</option>
                                <option value="Blocker">🔒 Used Blocker/Filtered Screen</option>
                                <option value="Hobby">🎨 Engaged in a Hobby (Reading, Writing)</option>
                                <option value="Cleanup">🧹 Environment Cleanup/Organizing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <button type="submit" class="w-full btn bg-primary hover:bg-primary/90 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-md shadow-primary/50">
                            Add Log Entry
                        </button>
                    </form>

                    <!-- Log History -->
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-secondary mb-3 border-b border-slate-600 pb-2">Log History (Impulses & Battles)</h3>
                        
                        <!-- NEW: Advanced Filter Section -->
                        <div id="log-filter-section" class="app-card p-4 mb-4 space-y-3">
                            <h4 class="text-base font-semibold text-primary">Advanced Filter: Date Range</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="date-start-filter" class="block text-xs font-medium text-slate-400">Start Date:</label>
                                    <input type="date" id="date-start-filter" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light text-sm" onchange="filterLogHistory()">
                                </div>
                                <div>
                                    <label for="date-end-filter" class="block text-xs font-medium text-slate-400">End Date:</label>
                                    <input type="date" id="date-end-filter" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light text-sm" onchange="filterLogHistory()">
                                </div>
                            </div>
                            <button onclick="resetLogFilter()" class="btn bg-slate-500 hover:bg-slate-600 text-white py-1 px-4 rounded-xl text-xs">
                                Reset Filter
                            </button>
                        </div>

                        <div id="log-history" class="space-y-4">
                            <p class="text-slate-400 text-sm">No impulse logs recorded yet.</p>
                        </div>
                    </div>
                </div>

                <!-- BATTLE & QUEST VIEW -->
                <div id="battle-quest-container" class="space-y-6 hidden">
                    
                    <!-- Monster Battle Log List (Active Encounters) -->
                    <div id="battle-log-list">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2">⚔️ Active Encounters</h2>
                         <div id="monster-list" class="space-y-3">
                             <p class="text-slate-400 text-sm">No active monsters. Log an impulse!</p>
                         </div>
                    </div>
                    
                    <!-- NEW SECTION: ENCOUNTER HISTORY -->
                    <div id="encounter-history-list" class="mt-8">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2 text-primary">📜 Past Encounters (Completed/Lost)</h2>
                         <div id="monster-history-container" class="space-y-3">
                            <!-- History will be rendered here -->
                         </div>
                    </div>

                    <!-- Individual Active Battle View (Only shows when a battle is selected) -->
                    <div id="active-battle-view" class="hidden space-y-6">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-secondary/50 pb-2 flex justify-between items-center">
                            <span class="truncate text-lg sm:text-xl">Active Battle: <span id="active-battle-title" class="text-secondary"></span></span>
                            <button onclick="viewActiveBattle(null)" class="btn bg-slate-600 hover:bg-slate-700 text-xs py-1 px-3 rounded-xl ml-2 transition flex-shrink-0">
                                <span class="hidden sm:inline">Back to All Encounters</span>
                                <span class="sm:hidden">⬅️ Back</span>
                            </button>
                         </h2>

                        <!-- Monster Battle Section -->
                        <div id="battle-section" class="space-y-4 p-4 app-card">
                            <div id="monster-display" class="text-center space-y-2">
                                <!-- Monster content injected here -->
                            </div>

                            <!-- Power Bar -->
                            <div class="space-y-2">
                                <p class="text-lg font-semibold text-secondary flex justify-between items-center">
                                    <span id="power-text">🛡️ Quests Completed Power: 0/100</span>
                                    <span id="weapon-text" class="text-sm text-slate-300"></span>
                                </p>
                                <div class="progress-bar-container">
                                    <div id="power-bar" class="progress-bar bg-yellow-500/80" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <!-- Attack Button (Now launches battle arena regardless of full power) -->
                            <button id="launch-battle-button" class="w-full btn bg-danger hover:bg-danger/90 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-md shadow-danger/50" onclick="launchTurnBasedBattle()">
                                💥 Launch Battle Arena
                            </button>

                            <p id="attack-status-message" class="text-sm text-yellow-400 text-center"></p>

                        </div>

                        <!-- Task List / Quest Log Section -->
                        <div id="quest-section">
                            <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2">Quests to Gain Power</h2>
                            <div id="tasks-list" class="space-y-3">
                                <!-- Tasks injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: SKILLS & MOVES VIEW -->
                <div id="skills-view-container" class="space-y-6 hidden">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">🧠 Sentinel Skills & Moves</h2>
                    <p class="text-sm text-slate-400">Unlock permanent, powerful moves for the Arena by completing challenging, strategic tasks.</p>

                    <div id="player-skills-list" class="space-y-4">
                        <!-- Skills injected here -->
                    </div>
                </div>

                <!-- NEW: GUIDE VIEW -->
                <div id="guide-view-container" class="space-y-6 hidden">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">❓ Sentinel Guide: Master the Impulse</h2>
                    
                    <div id="mystery-man-guide" class="app-card p-4 space-y-4">
                        <div class="flex items-center space-x-3 bg-slate-700 p-3 rounded-lg">
                            <span class="text-4xl">🎩</span>
                            <h3 class="text-xl font-bold text-secondary">The Mystery Man's Tutorial</h3>
                        </div>

                        <p class="text-text-light">Welcome, Sentinel. I am your guide, the silent architect of this arena. The path to mastering your impulse is simple, yet demanding. Follow these steps:</p>

                        <div class="space-y-4">
                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-primary">
                                <h4 class="font-bold text-text-light">1. Log the Impulse (The Scout Report)</h4>
                                <p class="text-sm text-slate-400 mt-1">When an urge arises, quickly navigate to the **📝 Log** section. Record the specific **Trigger** and the **Emotion** you feel. This action immediately spawns a Monster in the Battle Arena.</p>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-secondary">
                                <h4 class="font-bold text-text-light">2. Complete Quests (Gaining Power)</h4>
                                <p class="text-sm text-slate-400 mt-1">The Monster's Health is its resistance. To weaken it, go to the **⚔️ Battles** section and complete the assigned **Quests** (tasks like exercising, journaling, or setting up blockers). Each completed quest grants you **Power**.</p>
                                <p class="text-xs text-yellow-400 mt-1">**Prove your Quest!** Click the quest, submit written proof or a photo/video, and gain the reward.</p>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-success">
                                <h4 class="font-bold text-text-light">3. Launch the Battle (The Final Standoff)</h4>
                                <p class="text-sm text-slate-400 mt-1">Once you have enough **Power** (100+ is recommended), launch the **Impulse Battle Arena** against the Monster. Use your **Willpower Attack** and **Defend** strategy. If you win, you gain **XP** and permanent **Stat** increases. If you lose, your Power resets, and you must try again.</p>
                            </div>
                            
                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-danger">
                                <h4 class="font-bold text-text-light">4. Evolve (Skills & Stats)</h4>
                                <p class="text-sm text-slate-400 mt-1">Use your accumulated **XP** in the **🧠 Skills** section to unlock advanced psychological moves (like the Thought Record). Level up to permanently boost your **Willpower** and **Focus**.</p>
                            </div>
                        </div>

                        <p class="text-sm text-slate-400 pt-3 border-t border-slate-700 italic">May your resolve be unbreakable, Sentinel. You may access this guide anytime using the '❓ Guide' button.</p>
                    </div>
                </div>

                <!-- NEW: SETTINGS VIEW -->
                <div id="settings-view-container" class="space-y-6 hidden">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">⚙️ Personal Settings</h2>
                    <p class="text-sm text-slate-400">Edit your Warrior profile and access support options.</p>

                    <div class="app-card p-4 space-y-4">
                        <div class="flex justify-between items-center border-b border-slate-600 pb-3 mb-3">
                            <h3 class="text-lg font-bold text-secondary">Warrior Profile</h3>
                            <button type="button" id="edit-profile-btn" onclick="toggleSettingsEdit(true)" class="btn bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                                📝 Edit Details
                            </button>
                        </div>
                        <form id="settings-form" class="space-y-4">
                            
                            <!-- Private Fields - Now fully editable on toggle -->
                            <label for="settings-real-name" class="block text-sm font-medium text-text-light">Real Name (Private):</label>
                            <input type="text" id="settings-real-name" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light opacity-70 cursor-not-allowed" disabled>

                            <label for="settings-phone" class="block text-sm font-medium text-text-light">Phone Number (Private):</label>
                            <!-- FIX: Added oninput to settings field as well -->
                            <input type="tel" id="settings-phone" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light opacity-70 cursor-not-allowed" disabled>

                            <!-- Editable Fields -->
                            <label for="settings-name" class="block text-sm font-medium text-text-light">Warrior Alias (Public):</label>
                            <input type="text" id="settings-name" required class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light" disabled>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="settings-age" class="block text-sm font-medium text-text-light">Age:</label>
                                    <input type="number" id="settings-age" min="15" max="100" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light" disabled>
                                </div>
                                <div>
                                    <label for="settings-city" class="block text-sm font-medium text-text-light">City/Location:</label>
                                    <input type="text" id="settings-city" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light" disabled>
                                </div>
                            </div>
                            
                            <label for="settings-source" class="block text-sm font-medium text-text-light">How did you find us?</label>
                            <input type="text" id="settings-source" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light" disabled>


                            <div class="border-t border-slate-600 pt-3">
                                 <label for="settings-faith" class="block text-sm font-medium text-text-light">Faith/Belief System?</label>
                                 <select id="settings-faith" class="w-full p-2 rounded-lg bg-slate-600 border border-slate-500 text-text-light" disabled>
                                     <option value="no">No</option>
                                     <option value="yes">Yes</option>
                                 </select>
                            </div>


                            <label class="block text-sm font-medium pt-2 text-text-light border-t border-slate-600 pt-3">Core Stat Rating: Willpower</label>
                            <div class="flex justify-between text-xs text-slate-400"><span>1 (Weak)</span><span>10 (Unshakeable)</span></div>
                            <input type="range" id="settings-willpower" min="1" max="10" required oninput="document.getElementById('willpower-output').value=this.value" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer range-lg" disabled>
                            <output id="willpower-output" class="block text-center text-lg font-bold text-primary">5</output>

                            <label class="block text-sm font-medium pt-2 text-text-light border-t border-slate-600 pt-3">Core Stat Rating: Focus</label>
                            <div class="flex justify-between text-xs text-slate-400"><span>1 (Distracted)</span><span>10 (Laser Focus)</span></div>
                            <input type="range" id="settings-focus" min="1" max="10" required oninput="document.getElementById('focus-output').value=this.value" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer range-lg" disabled>
                            <output id="focus-output" class="block text-center text-lg font-bold text-primary">5</output>
                            
                            <label for="settings-purpose" class="block text-sm font-medium pt-2 text-text-light border-t border-slate-600 pt-3">Your immediate quest goal:</label>
                            <textarea id="settings-purpose" rows="3" placeholder="e.g., '1 week clean', 'Meditate daily'" required class="w-full p-3 rounded-lg bg-slate-600 border border-slate-500 focus:ring-secondary focus:border-secondary transition duration-150 text-text-light" disabled></textarea>

                            <button type="submit" id="settings-save-btn" class="w-full btn bg-success hover:bg-success/90 text-white font-semibold py-3 rounded-xl transition duration-200 mt-4 hidden">
                                Save Changes
                            </button>
                            <button type="button" id="settings-cancel-btn" onclick="toggleSettingsEdit(false)" class="w-full btn bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl transition duration-200 mt-2 hidden">
                                Cancel Edit
                            </button>
                        </form>
                    </div>

                    <!-- Contact/Support Section -->
                    <div class="p-4 app-card border-secondary/50 border text-center space-y-3">
                        <h3 class="text-lg font-bold text-secondary">Need Immediate Support?</h3>
                        <p class="text-sm text-text-light">If you are facing an urgent issue, require immediate support, or wish to report a bug, please contact our support line:</p>
                        <p class="text-2xl font-extrabold text-success">
                            <a href="tel:+919321563011" class="hover:underline">+919321563011</a>
                        </p>
                        <p class="text-xs text-slate-400">This number is available 24/7 for critical support.</p>
                    </div>

                    <!-- Delete Account Button -->
                    <div class="p-4 app-card border-danger/50 border text-center space-y-3">
                        <h3 class="text-lg font-bold text-danger">Danger Zone</h3>
                        <p class="text-sm text-slate-400">This action will delete all your character data, logs, XP, and progress. You will start the game from the very beginning.</p>
                        <button type="button" onclick="showGeneralModal('⚠️ Confirm Account Deletion', 'Are you sure you want to permanently delete ALL your progress? This cannot be undone.<br><br><button onclick=\'resetGame()\' class=\'btn bg-danger hover:bg-danger/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200\'>YES, DELETE EVERYTHING</button>')" class="w-full btn bg-danger hover:bg-danger/90 text-white font-semibold py-3 rounded-xl transition duration-200">
                            💀 DELETE ALL GAME DATA
                        </button>
                    </div>

                </div>
            
            <!-- 4. Outcome Message Box (For win/loss/instructions) -->
            <div id="message-box" class="p-4 rounded-xl text-center shadow-lg transition duration-300 hidden">
                <p id="message-text" class="text-lg font-medium"></p>
                <button id="reset-button" onclick="resetGame()" class="mt-4 btn bg-success hover:bg-success/90 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 hidden">
                    Start a New Battle
                </button>
            </div>

        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR DEPLOYED GOOGLE SCRIPT URL FOR DATA LOGGING
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzH_LnFvhbixp_IbaInbj-p6Z-IYH67VOySkFU8XusOhtwlhjWn6iuqJ21OhKRRSWmp0g/exec'; 

        // --- Persistence Keys ---
        const PROGRESS_KEY = 'addiction_fighter_progress'; // Monster progression wins
        const CHARACTER_KEY = 'addiction_fighter_character'; // User profile and base stats
        const LOG_HISTORY_KEY = 'addiction_fighter_logs'; // Stores all detailed log entries
        const SKILLS_KEY = 'addiction_fighter_skills'; // Stores unlocked player skills'

        // --- BATTLE ARENA STATE (MUST BE DECLARED GLOBALLY FIRST) ---
        let battleArenaState = {
            currentMonsterLog: null,
            monsterCurrentHP: 0,
            playerCurrentHP: 0,
            isPlayerTurn: true,
            isLocked: false, // For effects like Silent Shackles
            playerDefending: false,
            playerWillpowerModifier: 0, // Temporary debuff
            playerFocusModifier: 0,    // Temporary debuff
        };
        
        // --- DATA LOGGING FUNCTIONS (MUST BE DECLARED GLOBALLY FIRST) ---
        
        /**
         * Sends data to a deployed Google Script Web App URL.
         * @param {Object} data The payload to send (e.g., char data, log data).
         * @param {string} sheetName The name of the sheet to record data (e.g., 'Profile', 'Logs').
         */
        async function logDataToSheet(data, sheetName) {
            if (GOOGLE_SHEET_URL.includes('YOUR_GOOGLE_SCRIPT_WEB_APP_URL')) {
                console.warn(`[Sheet Logging] Skipped: Please set GOOGLE_SHEET_URL in the script.`);
                return;
            }

            const payload = {
                action: 'logData',
                sheet: sheetName,
                data: {
                    ...data,
                    timestamp: new Date().toISOString()
                }
            };

            try {
                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Script POST requests
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                // Note: Since mode is 'no-cors', response status checks are often unreliable.
                console.log(`[Sheet Logging] Data sent to ${sheetName}. Response (may be opaque):`, response);
            } catch (error) {
                console.error(`[Sheet Logging] Failed to send data to ${sheetName}:`, error);
            }
        }


        // --- Configuration: Tasks remain constant ---
        // NEW: Increased complexity and quantity of tasks
        const TRIGGER_SPECIFIC_QUESTS = {
            'Loneliness': [
                { id: 'reach_out', name: '🤝 Contact 2 Trusted People (Text/Call)', value: 25, description: 'Break the isolation spiral and strengthen your support network.', instructions: 'Reach out via text or phone call to two friends, family members, or mentors. Focus on connection, not on your urge.', instructions: 'Reach out via text or phone call to two friends, family members, or mentors. Focus on connection, not on your urge.', proof: 'Text Proof: Submit the names (or initials) of the two people you contacted, and briefly state the purpose of the communication (e.g., "Connected with Jane about my goals").' },
                { id: 'social_plan', name: '🗓️ Plan a Social Activity', value: 15, description: 'Schedule something positive to look forward to this week.', instructions: 'Plan a specific, time-bound social activity with someone (or a group) for the coming week. This must be outside of the home/computer.', proof: 'Text Proof: State the activity, date, and who you planned it with.' },
                { id: 'public_place', name: '🚶 Spend 15 mins in a Public Place (Library/Cafe)', value: 20, description: 'Re-acclimate to being around others without direct interaction.', instructions: 'Go to a public place (like a park, library reading room, or cafe) and simply observe for 15 minutes. No phone use allowed.', proof: 'Text or File Proof: Describe the location and three distinct things you observed (e.g., "Park near work, saw a dog, a couple reading, and a bird"). Photo proof of the location is also acceptable.' },
                { id: 'help_stranger', name: '🙋 Offer Help to a Stranger (Small favor)', value: 30, description: 'Shift focus from self to others to boost connection hormones.', instructions: 'Perform a small act of service for a stranger, like holding a door, helping someone pick up dropped items, or giving a genuine compliment.', proof: 'Text Proof: Describe the small favor you did and the person\'s reaction.' },
                { id: 'pet_time', name: '🐶 Spend 30 mins with a Pet or Animal', value: 10, description: 'Nurture another creature for immediate emotional comfort.', instructions: 'If you have a pet, dedicate 30 minutes to playing with or grooming them. If not, visit a friend with a pet or spend time at a local shelter.', proof: 'File Proof: A photo or short video of you interacting with the animal is required.' },
                { id: 'read_support', name: '📖 Read 1 Article on Social Connection', value: 5, description: 'Learn a new psychological technique to combat isolation.', instructions: 'Search for and read an article (5+ minutes of reading) about combating loneliness, social skills, or connection strategies.', proof: 'Text Proof: State the title of the article and one key takeaway you learned.' },
                { id: 'family_check', name: '👨‍👩‍👧‍👦 Check-in with a Family Member (Video/Call)', value: 35, description: 'Deepen familial bonds and reduce feelings of solitude.', instructions: 'Have a meaningful conversation (15+ minutes) with a close family member.', proof: 'Text Proof: State who you spoke to and the main topic of conversation.' },
                { id: 'write_gratitude', name: '📝 Write 3 Things You Value in Your Support System', value: 10, description: 'Focus on existing resources instead of perceived lack.', instructions: 'Write down three specific relationships or support resources you have and why they are valuable to you.', proof: 'Text Proof: Write out the three points you identified.' },
            ],
            'Boredom': [
                { id: '5_min_cleanup', name: '🧹 Tidy up One Area for 5 Minutes', value: 15, description: 'Combat idleness with productive, immediate movement.', instructions: 'Immediately set a timer for 5 minutes and organize a small, messy area (e.g., your desk, nightstand, or a kitchen counter).', proof: 'File Proof: Submit a photo of the area *after* it has been tidied.' },
                { id: 'new_hobby_learn', name: '🎨 Research a New Hobby (10 mins)', value: 10, description: 'Spark curiosity and create a plan for structured time.', instructions: 'Spend 10 minutes researching a hobby you\'ve always wanted to try (e.g., drawing, programming, playing an instrument). Find a specific tutorial or tool.', proof: 'Text Proof: State the hobby, and paste one link or resource you found.' },
                { id: 'cook_meal', name: '🍜 Cook a Simple, Healthy Meal', value: 20, description: 'Engage multiple senses in a rewarding process.', instructions: 'Cook and eat a meal from scratch. Focus on the steps involved in preparation.', proof: 'File Proof: Submit a photo of the finished, healthy meal.' },
                { id: 'puzzle_game', name: '🧩 Complete a Puzzle or Logic Game (15 mins)', value: 15, description: 'Re-direct mental energy into a positive, focused challenge.', instructions: 'Spend 15 minutes working on a physical puzzle, Sudoku, crossword, or a mind-numbing logic app/game.', proof: 'Text Proof: Describe the type of puzzle and what step you completed.' },
                { id: 'exercise_short', name: '🤸 15 Minutes of Stretching or Light Cardio', value: 25, description: 'Change your physical state to change your mental state.', instructions: 'Engage in 15 continuous minutes of non-strenuous physical activity, like cycling, stretching, or brisk walking.', proof: 'File Proof: A photo of you stretching, or a screenshot of a 15-minute timer/fitness app activity log.' },
                { id: 'listen_podcast', name: '🎧 Listen to an Educational Podcast (15 mins)', value: 5, description: 'Fill idle time with valuable learning input.', instructions: 'Listen actively to an episode of an informative podcast for at least 15 minutes. The topic must be non-triggering.', proof: 'Text Proof: State the name of the podcast and one interesting fact you learned.' },
                { id: 'water_plants', name: '💧 Tend to Plants/Garden for 10 minutes', value: 10, description: 'Ground yourself in real-world caretaking.', instructions: 'Water, prune, or check on all the plants you own, or dedicate 10 minutes to a community garden/outdoor space.', proof: 'File Proof: A photo of your watered plant or gardening area.' },
                { id: 'brainstorm_day', name: '🧠 Brainstorm 3 Non-Screen Activities for Tomorrow', value: 20, description: 'Pre-empt boredom by planning engaging alternatives.', instructions: 'Write down three specific activities you will do tomorrow that do NOT involve a computer or phone.', proof: 'Text Proof: List the three planned activities.' },
            ],
            'Stress/Anxiety': [
                { id: 'meditate_10', name: '🧘 10 Minutes of Focused Meditation', value: 30, description: 'Activate the parasympathetic nervous system to calm the fight-or-flight response.', instructions: 'Complete a guided or unguided meditation session for at least 10 minutes. Focus on your breath.', proof: 'File Proof: A screenshot of your meditation app showing the 10+ minute session, or a written journal entry about the experience.' },
                { id: 'box_breath', name: '🌬️ 5 Minutes of Box Breathing', value: 25, description: 'Regulate heart rate and ground the mind in the present moment.', instructions: 'Perform box breathing (inhale 4, hold 4, exhale 4, hold 4) for 5 consecutive minutes.', proof: 'Text Proof: State the time you completed the breathing exercise and how you felt afterward.' },
                { id: 'write_worry', name: '📝 Perform a "Worry Dump" (Write down all fears)', value: 15, description: 'Externalize anxious thoughts to reduce their emotional power.', instructions: 'Spend 15 minutes writing down every single worry or fear currently in your mind, no matter how small or irrational. Tear up the paper afterward.', proof: 'File Proof: A photo of the page filled with writing (content can be blurred/unreadable for privacy).' },
                { id: 'listen_music', name: '🎶 Listen to Calming Music for 15 mins', value: 10, description: 'Use auditory input to shift mood and focus.', instructions: 'Listen to 15 minutes of classical, instrumental, or ambient music. Do nothing else during this time.', proof: 'Text Proof: State the genre/artist you listened to and what you focused on during the 15 minutes.' },
                { id: 'drink_water', name: '💧 Drink a Full Glass of Water Slowly', value: 5, description: 'Simple physical act to interrupt the anxiety cycle.', instructions: 'Drink a full 8oz glass of water very slowly, focusing on the feeling of hydration.', proof: 'Text Proof: Confirm the completion of this task.' },
                { id: 'sensory_focus', name: '✋ 5-4-3-2-1 Grounding Exercise', value: 20, description: 'Focus on 5 senses to bring attention away from internal stress.', instructions: 'Complete the 5-4-3-2-1 exercise: Name 5 things you can see, 4 you can touch, 3 you can hear, 2 you can smell, and 1 you can taste.', proof: 'Text Proof: Write down the first item you identified for each sense (5 items total).' },
                { id: 'walk_outside', name: '🌳 Take a 15-minute Mindful Walk Outside', value: 35, description: 'Change of environment + physical activity reduces tension.', instructions: 'Take a walk for 15 minutes specifically focused on your surroundings—colors, sounds, textures, air temperature.', proof: 'Text Proof: Describe three things you noticed on your mindful walk.' },
                { id: 'task_split', name: '✂️ Break Down an Overwhelming Task into 3 Sub-steps', value: 10, description: 'Reduce anxiety by creating a manageable plan.', instructions: 'Identify one overwhelming task you need to do and write down the first three very simple steps required to start it.', proof: 'Text Proof: State the main task and the three sub-steps.' },
            ],
            'Late Night Urge': [
                { id: 'off_device', name: '🔌 Power Down All Devices (30 mins early)', value: 40, description: 'Remove the source of the trigger environment.', instructions: 'Shut down your primary computer and place your phone outside your bedroom (or in a drawer) at least 30 minutes before your usual trigger time.', proof: 'File Proof: A photo of your devices put away/off, or a screenshot of your screen time tracker showing reduced late-night usage.' },
                { id: 'brush_teeth', name: '🪥 Perform Full Nighttime Hygiene Routine', value: 10, description: 'A physical signal to the brain that the day is over.', instructions: 'Complete your full nighttime routine: brush teeth, floss, wash face, etc. This signals the start of the wind-down period.', proof: 'Text Proof: Confirm completion of your full routine.' },
                { id: 'read_physical', name: '📚 Read a Physical Book in Bed', value: 15, description: 'Engage the mind without blue light or triggering content.', instructions: 'Read a physical, non-triggering book (or magazine/comic) for 15 minutes. Absolutely no screens.', proof: 'File Proof: A photo of the physical book you were reading.' },
                { id: 'dim_lights', name: '💡 Use Only Dim, Warm Lighting', value: 5, description: 'Encourage melatonin production and prepare for sleep.', instructions: 'Turn off all bright overhead lights and only use warm lamps or bedside lights for 30 minutes before bed.', proof: 'Text Proof: Confirm completion.' },
                { id: 'prep_tomorrow', name: '💼 Lay Out Clothes/Work for Tomorrow', value: 20, description: 'Focus on future productivity and sleep ritual.', instructions: 'Take 10 minutes to lay out the clothes you will wear tomorrow and prepare any necessary items for work/school.', proof: 'Text or File Proof: Confirm or submit a photo of the laid-out items.' },
                { id: 'early_bed', name: '🛌 Get to Bed 1 Hour Earlier', value: 30, description: 'Prioritize restorative sleep to rebuild willpower reserves.', instructions: 'Attempt to get into bed (lights off) a full hour earlier than your habitual sleep time.', proof: 'Text Proof: State your usual sleep time and the time you went to bed.' },
                { id: 'no_snack', name: '🍎 Replace Night Snack with Water/Tea', value: 10, description: 'Prevent habit stacking around bedtime.', instructions: 'If you typically snack before bed, replace that snack tonight with only water or herbal tea.', proof: 'Text Proof: Confirm the replacement.' },
                { id: 'music_sleep', name: '💤 Listen to Sleep Story/White Noise', value: 15, description: 'Prevent mind wandering in bed.', instructions: 'Play non-lyrical sleep music or a sleep story through a speaker (not headphones) for 15 minutes.', proof: 'Text Proof: State the type of audio used.' },
            ],
            'Media/Phone Triggers': [
                { id: 'blocker_setup', name: '🔒 Set up/Update a Content Blocker', value: 50, description: 'Establish a powerful environmental shield against access.', instructions: 'Install a new content blocker app (like Cold Turkey or Freedom) on your device(s), or update the rules on your existing blocker to be more restrictive.', proof: 'File Proof: A screenshot of the blocker app\'s main screen showing the active block list/settings.' },
                { id: 'app_delete', name: '📱 Delete 1 Tempting App (Social/Game)', value: 35, description: 'Increase friction to reduce impulsive access.', instructions: 'Identify one app that frequently leads to triggering content or urges and delete it from your phone for at least 24 hours.', proof: 'Text Proof: State which app you deleted and why.' },
                { id: 'filter_time', name: '⏱️ Set 30-min Time Limit on Social Media App', value: 25, description: 'Implement structured control over usage time.', instructions: 'Use your phone\'s native screen time settings (or a third-party app) to set a strict 30-minute daily limit on one high-risk app (e.g., Instagram, TikTok, Reddit).', proof: 'File Proof: A screenshot of your phone\'s settings showing the time limit enforced.' },
                { id: 'phone_box', name: '📦 Put Phone/Device in Another Room for 1 Hour', value: 45, description: 'Create physical distance from the trigger source.', instructions: 'Place your phone, tablet, or main trigger device in a specific container or room away from you for a continuous 60 minutes. Engage in an offline activity during this time.', proof: 'Text or File Proof: State the offline activity and the time range (e.g., "6 PM - 7 PM, worked on cooking").' },
                { id: 'grayscale', name: '🎚️ Turn Phone Screen to Grayscale for 1 Day', value: 20, description: 'Reduce visual stimulus and make the phone less appealing.', instructions: 'Change your phone settings to display in grayscale (black and white) for the rest of the day. This reduces the addictiveness of visual content.', proof: 'File Proof: A screenshot of your phone screen in grayscale mode.' },
                { id: 'notification_off', name: '🔕 Turn Off All Non-Essential Notifications', value: 10, description: 'Reduce interruptions that draw you back to the device.', instructions: 'Go through your app settings and disable all non-essential notifications (e.g., social media alerts, news updates). Leave only texts/calls active.', proof: 'Text Proof: State which apps you disabled notifications for.' },
                { id: 'laptop_put_away', name: '💻 Shut down and Store Laptop for 3 hours', value: 30, description: 'Designate a time-box for being completely offline.', instructions: 'If your computer is a trigger, perform a full shutdown and put it away for a minimum of 3 consecutive hours during waking hours.', proof: 'Text Proof: State the 3-hour time period and what you did instead.' },
                { id: 'media_clean', name: '🗑️ Unsubscribe from 5 Tempting Email Lists/Accounts', value: 15, description: 'Cleanse the inflow of potential triggers.', instructions: 'Unsubscribe from five email lists, channels, or accounts that frequently send triggering or distracting content.', proof: 'Text Proof: List the 5 entities you unsubscribed from.' },
            ],
            'Curiosity': [
                { id: 'write_consequences', name: '✍️ Write Down 3 Negative Consequences of relapse', value: 20, description: 'Consciously confront the reality of the choice.', instructions: 'On paper or in a note app, write down three specific, painful consequences that usually follow a relapse (e.g., shame, lost sleep, missing a workout). Review them when the urge peaks.', proof: 'Text Proof: List the three consequences you wrote down.' },
                { id: 'future_self', name: '💭 Write a 1-year Goal Letter to Future Self', value: 15, description: 'Strengthen focus on long-term identity over short-term impulse.', instructions: 'Write a letter to yourself, dated one year from now, describing where you hope to be, what you hope to have achieved, and how proud you are of your current strength.', proof: 'Text Proof: State the central theme of the letter.' },
                { id: 'delay_15', name: '⏱️ Delay Action for 15 Minutes (Set a Timer)', value: 30, description: 'Prove that the urge is temporary and resistible.', instructions: 'When the urge strikes, immediately set a timer for 15 minutes. Do not engage with the trigger during this time. Do a harmless, focused activity like tidying or walking instead.', proof: 'File Proof: A screenshot of the 15-minute timer successfully completed.' },
                { id: 'research_topic', name: '🧐 Research a Non-Addictive Topic for 15 mins (Science/History)', value: 10, description: 'Satisfy the cognitive urge for novelty constructively.', instructions: 'Use the internet to research a subject that genuinely interests you but is completely unrelated to your triggers (e.g., astrophysics, ancient history, bird species) for 15 minutes.', proof: 'Text Proof: State the topic you researched and one surprising fact you learned.' },
                { id: 'talk_out_loud', name: '🗣️ Talk Out Loud About the Urge (5 mins)', value: 25, description: 'Use verbal processing to break the internal fantasy loop.', instructions: 'Go to a private area and talk out loud about the urge you are feeling for five continuous minutes, treating it as an outside problem you are analyzing.', proof: 'Text Proof: Describe the main point of your verbal self-talk and how it felt to externalize the urge.' },
                { id: 'clean_wallet', name: '💳 Clean out Wallet/Purse/Digital Accounts', value: 5, description: 'Focus on simple, real-world organization.', instructions: 'Organize your physical wallet/purse or delete unnecessary saved credit card info from your phone/browser.', proof: 'Text Proof: Confirm the cleaning action and what you found/deleted.' },
                { id: 'read_faith', name: '✨ Read 1 Page of Faith/Spiritual Text (if applicable)', value: 35, description: 'Reinforce guiding principles and core values.', instructions: 'Read one page of a text that aligns with your faith or core spiritual beliefs. Focus on the message of personal strength.', proof: 'Text or File Proof: State the source of the reading and one phrase that resonated with you.' },
                { id: 'journal_why', name: '❓ Journal: "Why did this impulse appear right now?"', value: 10, description: 'Analyze the impulse instead of reacting to it.', instructions: 'Immediately write a brief, honest entry analyzing the circumstances (time, place, emotion) that led to the impulse.', proof: 'Text Proof: State the core emotion and circumstance you identified.' },
            ],
            'Rejection/Failure': [
                 { id: 'affirmations', name: '🛡️ Write 5 Self-Affirmations on Strengths', value: 25, description: 'Counter feelings of failure with evidence of self-worth.', instructions: 'Write down five positive, true statements about your character or past successes. Read them out loud three times.', proof: 'Text Proof: List the five affirmations.' },
                 { id: 'forgive_self', name: '🧘 Perform a 5-min Self-Compassion Exercise', value: 30, description: 'Treat yourself with kindness instead of resorting to shame.', instructions: 'Set a timer for 5 minutes. Close your eyes and silently talk to yourself with the same kindness you would offer a struggling friend.', proof: 'Text Proof: State the primary message of compassion you gave yourself.' },
                 { id: 'call_mentor', name: '🤝 Call a Mentor/Accountability Partner (Must Answer)', value: 45, description: 'Leverage external support during emotional vulnerability.', instructions: 'Call or video chat with a trusted mentor or accountability partner. The conversation must be focused on your feelings, even if you don\'t mention the specific trigger.', proof: 'Text Proof: State who you called, and the duration of the call (e.g., "Mentor J, 18 minutes").' },
                 { id: 'review_log', name: '📜 Review 1 Past Victory Log Entry', value: 15, description: 'Remind yourself of previous success and competence.', instructions: 'Navigate to your Log History, find a log where you successfully resisted, and reread the positive outcome. Focus on the feeling of victory.', proof: 'Text Proof: State the date/time of the log entry you reviewed and one action you took to resist in that log.' },
                 { id: 'learn_from', name: '✍️ Write 3 Lessons Learned from the "Failure"', value: 10, description: 'Reframe the event as a learning opportunity, not a personal flaw.', instructions: 'If you just experienced a setback (failure/rejection), write down three objective lessons you can take away from the experience to improve next time.', proof: 'Text Proof: List the three objective lessons learned.' },
                 { id: 'physical_vent', name: '💥 Punch a Pillow or Exercise Hard (10 mins)', value: 20, description: 'Safely discharge emotional energy from frustration.', instructions: 'Spend 10 minutes performing vigorous physical activity (e.g., pushups, shadow boxing, running in place) to process the anger/frustration physically.', proof: 'Text or File Proof: Confirm the 10-minute activity and how your energy shifted afterward.' },
                 { id: 'journal_feeling', name: '📝 Journal: Describe the Feeling, Not the Event', value: 5, description: 'Separate the emotion from the external event.', instructions: 'In a journal, write only about the physical and emotional sensations you are currently feeling. Avoid writing about the person or event that caused the feelings.', proof: 'Text Proof: Describe one physical sensation and one emotional sensation you wrote about.' },
                 { id: 'new_goal', name: '🎯 Set One Very Small, Achievable Goal for the next hour', value: 10, description: 'Rebuild momentum with immediate success.', instructions: 'Set a goal so small you cannot fail (e.g., "make coffee," "read one email"). Complete it immediately.', proof: 'Text Proof: State the small goal and confirm its completion.' },
            ]
        };

        // Combine all quests into a single array for length check and fallback
        const ALL_QUESTS = Object.values(TRIGGER_SPECIFIC_QUESTS).flat();
        
        // --- Research-Based Player Skills (Unlockable Moves) ---
        // Based on CBT, Mindfulness, and Behavioral Strategies
        const ALL_PLAYER_SKILLS = [
            { id: 'thought_record', name: 'CBT Thought Record', cost: 250, unlocked: false, 
              desc: '💡 Identify and challenge a core distorted thought. **Attack Bonus +20%**, cures LOCK effect.', 
              type: 'Attack', powerCost: 100 }, // Needs 100 Power to use in battle
            { id: 'mindfulness_shield', name: 'Mindfulness Shield', cost: 400, unlocked: false, 
              desc: '🧘 Focus on the present. **Defense Boost +50%** for next Monster turn.', 
              type: 'Defend', powerCost: 150 },
            { id: 'delay_gratification', name: 'Delay Gratification', cost: 500, unlocked: false, 
              desc: '⏳ Stall the Urge. **Heals +10 HP** and delays Monster turn by 1.', 
              type: 'Heal', powerCost: 200 },
            { id: 'support_call', name: 'Support System Call', cost: 750, unlocked: false, 
              desc: '🤝 Use social accountability. **Heals +30 HP** and deals minor damage (10).', 
              type: 'Heal', powerCost: 300 }
        ];

        // --- Configuration: Trigger to Type Mapping (For Monster Spawn) ---
        const TRIGGER_MAP = [
            { keyword: 'alone', type: 'Loneliness', emoji: '👤' },
            { keyword: 'bored', type: 'Boredom', emoji: '😴' },
            { keyword: 'stress', type: 'Stress/Anxiety', emoji: '😟' },
            { keyword: 'anxiety', type: 'Stress/Anxiety', emoji: '😟' },
            { keyword: 'night', type: 'Late Night Urge', emoji: '🌙' },
            { keyword: 'late', type: 'Late Night Urge', emoji: '🌙' },
            { keyword: 'checking', type: 'Curiosity', emoji: '🧐' },
            { keyword: 'sad', type: 'Sadness/Depression', emoji: '😔' },
            { keyword: 'depress', type: 'Sadness/Depression', emoji: '😔' },
            { keyword: 'routine', type: 'Boredom', emoji: '⚙️' },
            { keyword: 'pattern', type: 'Boredom', emoji: '⚙️' },
            { keyword: 'scroll', type: 'Media/Phone Triggers', emoji: '📱' },
            { keyword: 'media', type: 'Media/Phone Triggers', emoji: '📱' },
            { keyword: 'reject', type: 'Rejection/Failure', emoji: '💔' },
            { keyword: 'fail', type: 'Rejection/Failure', emoji: '💔' },
            { keyword: 'once', type: 'Curiosity', emoji: '🐍' },
            { keyword: 'tired', type: 'Late Night Urge', emoji: '😩' },
            { keyword: 'exhaust', type: 'Late Night Urge', emoji: '😩' },
            { keyword: 'anger', type: 'Stress/Anxiety', emoji: '🔥' },
            { keyword: 'frustra', type: 'Stress/Anxiety', emoji: '🔥' },
            { keyword: 'fantasy', type: 'Curiosity', emoji: '💭' },
            { keyword: 'imagination', type: 'Curiosity', emoji: '💭' },
            { keyword: 'change', type: 'Rejection/Failure', emoji: '🌑' },
        ];

        // --- Configuration: Monster Progression ---
        // Tasks factor is now simply a multiplier for the *number* of tasks assigned
        const MONSTER_PROGRESSION = {
            'Loneliness': [
                { stage: 1, name: 'Shadow of Emptiness', tasks_multiplier: 1.0, skills: [{ name: 'Isolation Grip (Weak)', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Tethered Spectre', tasks_multiplier: 1.5, skills: [{ name: 'Isolation Grip', damage: 15, effect: 'Lower Focus' }, { name: 'Whispers of Despair', damage: 8, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Hollow Wraith (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Isolation Grip (Crit)', damage: 20, effect: 'Lower Focus' }, { name: 'Silent Shackles', damage: 0, effect: 'Lock' }] },
            ],
            'Boredom': [
                { stage: 1, name: 'Beast of Idleness', tasks_multiplier: 1.0, skills: [{ name: 'Slumber Cloud (Weak)', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Slumbering Giant', tasks_multiplier: 1.5, skills: [{ name: 'Time Drain', damage: 12, effect: 'Lower XP' }, { name: 'Slumber Cloud', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Boredom Behemoth (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Time Drain (Crit)', damage: 18, effect: 'Lower XP' }, { name: 'Time Warp', damage: 10, effect: 'Halve Attack' }] },
            ],
            'Stress/Anxiety': [
                { stage: 1, name: 'Phantom of Pressure', tasks_multiplier: 1.0, skills: [{ name: 'Panic Aura (Weak)', damage: 15, effect: 'None' }] },
                { stage: 2, name: 'Cloaked Nightmare', tasks_multiplier: 1.5, skills: [{ name: 'Panic Aura', damage: 20, effect: 'None' }, { name: 'Mind Fog', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Stress Tyrant (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Panic Aura (Crit)', damage: 25, effect: 'None' }, { name: 'Total Lock Down', damage: 0, effect: 'Lock' }] },
            ],
            'Late Night Urge': [
                { stage: 1, name: 'Night Stalker', tasks_multiplier: 1.0, skills: [{ name: 'Dark Temptation (Weak)', damage: 12, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Shadow Splitter', tasks_multiplier: 1.5, skills: [{ name: 'Dark Temptation', damage: 18, effect: 'Lower Willpower' }, { name: 'Sleep Drain', damage: 8, effect: 'Lower HP' }] },
                { stage: 3, name: 'Midnight Reaper (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Dark Temptation (Crit)', damage: 22, effect: 'Lower Willpower' }, { name: 'Temporal Loop', damage: 15, effect: 'Double Attack' }] },
            ],
            'Curiosity': [
                { stage: 1, name: 'Trickster of Illusion', tasks_multiplier: 1.0, skills: [{ name: 'Whispering Temptation (Weak)', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Mirror Clone', tasks_multiplier: 1.5, skills: [{ name: 'Illusion Split', damage: 15, effect: 'Lower HP' }, { name: 'Whispering Temptation', damage: 15, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Deceiver Mind (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Illusion Split (Crit)', damage: 20, effect: 'Lower HP' }, { name: 'Focus Block', damage: 0, effect: 'Halve Damage' }] },
            ],
            'Rejection/Failure': [
                { stage: 1, name: 'Wound of Disappointment', tasks_multiplier: 1.0, skills: [{ name: 'Shame Spike (Weak)', damage: 12, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Regret Golem', tasks_multiplier: 1.5, skills: [{ name: 'Shame Spike', damage: 18, effect: 'Lower Willpower' }, { name: 'Guilt Trap', damage: 8, effect: 'Lock' }] },
                { stage: 3, name: 'Apathy Titan (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Shame Spike (Crit)', damage: 22, effect: 'Lower Willpower' }, { name: 'Total Shut Down', damage: 0, effect: 'Lock' }] },
            ],
            // Default progression for unmapped triggers
            'Unclassified Monster': [
                 { stage: 1, name: 'The Unseen Foe', tasks_multiplier: 1.0, skills: [{ name: 'Ambush', damage: 10, effect: 'None' }] },
                 { stage: 2, name: 'Ambient Threat', tasks_multiplier: 1.5, skills: [{ name: 'Stat Reduction', damage: 15, effect: 'Lower Focus/Will' }] },
                 { stage: 3, name: 'Chaos Demon (Elite)', tasks_multiplier: 2.0, skills: [{ name: 'Rage Burst', damage: 25, effect: 'None' }] },
            ]
        };

        const XP_TO_LEVEL_UP = 1000;

        const INITIAL_STATE = {
            phase: 'creation', 
            // Character Stats
            charName: '',
            charRealName: '', // NEW
            charCity: '', // NEW
            charSource: '', // NEW
            charPhone: '', // NEW
            charLevel: 1,
            charHP: 0,
            charXP: 0,
            charWillpower: 0,
            charFocus: 0,
            charMotivation: 0,
            charDefense: 0,
            charSpecial: '',
            charPurpose: '', 
            charAge: 0, // Ensure age is initialized

            // Battle State (Simplified for multi-battle support)
            activeLogId: null, // ID of the battle the user is currently focused on
            
            dashboardView: 'log', 
            unlockedSkills: [], // Array of unlocked skill IDs
        };

        let gameState = { ...INITIAL_STATE };
        let PLAYER_SKILLS = []; // Initialized by loadSkills()

        // --- DOM Elements (Declared globally for event handlers) ---
        const splashScreen = document.getElementById('splash-screen');
        const charCreationSection = document.getElementById('character-creation-section');
        const characterForm = document.getElementById('character-form');
        const triggerForm = document.getElementById('trigger-form');
        const triggerSpecificInput = document.getElementById('trigger-specific'); 
        const triggerSection = document.getElementById('trigger-section');
        
        // Navigation Elements
        const dashboardNav = document.getElementById('dashboard-nav');
        const navLogBtn = document.getElementById('nav-log');
        const navBattleBtn = document.getElementById('nav-battle');
        const navSkillsBtn = document.getElementById('nav-skills'); // NEW REF
        const navGuideBtn = document.getElementById('nav-guide'); 
        const navSettingsBtn = document.getElementById('nav-settings'); 
        const logViewContainer = document.getElementById('log-view-container'); 
        const battleQuestContainer = document.getElementById('battle-quest-container'); 
        const skillsViewContainer = document.getElementById('skills-view-container'); 
        const settingsViewContainer = document.getElementById('settings-view-container'); 
        const guideViewContainer = document.getElementById('guide-view-container'); 
        
        // Battle View Specific Elements
        const battleLogList = document.getElementById('battle-log-list'); 
        const monsterListContainer = document.getElementById('monster-list'); 
        const monsterHistoryContainer = document.getElementById('monster-history-container'); // CORRECTED REF ID
        const activeBattleView = document.getElementById('active-battle-view'); 
        const activeBattleTitle = document.getElementById('active-battle-title'); 
        
        const monsterDisplay = document.getElementById('monster-display');
        const tasksList = document.getElementById('tasks-list');
        const powerBar = document.getElementById('power-bar');
        const powerText = document.getElementById('power-text');
        const weaponText = document.getElementById('weapon-text');
        const attackButton = document.getElementById('attack-button');
        const launchBattleButton = document.getElementById('launch-battle-button'); 
        const attackStatusMessage = document.getElementById('attack-status-message'); 
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const resetButton = document.getElementById('reset-button');
        const avatarContainer = document.getElementById('avatar-container');
        const statsPanel = document.getElementById('stats-panel');
        
        // General Modal Elements
        const generalModal = document.getElementById('general-modal');
        const generalModalTitle = document.getElementById('general-modal-title');
        const generalModalMessage = document.getElementById('general-modal-message');

        // Battle Arena Elements
        const battleArenaModal = document.getElementById('battle-arena-modal');
        const arenaLog = document.getElementById('arena-log');
        const arenaMonsterEmoji = document.getElementById('arena-monster-emoji');
        const arenaMonsterName = document.getElementById('arena-monster-name');
        const arenaMonsterHpBar = document.getElementById('arena-monster-hp-bar');
        const arenaMonsterHpText = document.getElementById('arena-monster-hp-text');
        const arenaPlayerEmoji = document.getElementById('arena-player-emoji');
        const arenaPlayerName = document.getElementById('arena-player-name');
        const arenaPlayerHpBar = document.getElementById('arena-player-hp-bar');
        const arenaPlayerHpText = document.getElementById('arena-player-hp-text');
        const arenaAttackBtn = document.getElementById('arena-attack-btn');
        const arenaMessage = document.getElementById('arena-message');

        // Multi-Step Form Elements
        const stepElements = ['step-1', 'step-2', 'step-3', 'step-4'];
        const currentStepInput = document.getElementById('current-step');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const creationTitle = document.getElementById('creation-title');
        const creationSubtitle = document.getElementById('creation-subtitle');
        
        // Log Form Elements
        const logDateInput = document.getElementById('log-date');
        const actionTakenGroup = document.getElementById('action-taken-group');
        const gaveInFields = document.getElementById('gave-in-fields');
        const logAfterFeelings = document.getElementById('log-after-feelings');
        const logTriggerType = document.getElementById('trigger-type'); 
        const logTriedInstead = document.getElementById('log-tried-instead');
        const resistedFields = document.getElementById('resisted-fields');
        const logHistoryContainer = document.getElementById('log-history'); 
        
        // Log Filter Elements
        const dateStartFilter = document.getElementById('date-start-filter');
        const dateEndFilter = document.getElementById('date-end-filter');


        // Proof Modal Elements
        const proofModal = document.getElementById('proof-modal');
        const proofForm = document.getElementById('proof-form');
        const proofTaskName = document.getElementById('proof-task-name');
        const proofPowerReward = document.getElementById('proof-power-reward'); 
        const proofTaskIdInput = document.getElementById('proof-task-id');
        const proofFileInput = document.getElementById('proof-file');
        const proofTextarea = document.getElementById('proof-text');
        const proofPreview = document.getElementById('proof-preview'); 
        const proofTypeSelect = document.getElementById('proof-type-select');
        const fileProofContainer = document.getElementById('file-proof-container');
        const textProofContainer = document.getElementById('text-proof-container');
        
        // Settings Form Elements
        const settingsForm = document.getElementById('settings-form');
        const settingsRealNameInput = document.getElementById('settings-real-name'); // NEW REF
        const settingsCityInput = document.getElementById('settings-city'); // NEW REF
        const settingsSourceInput = document.getElementById('settings-source'); // NEW REF
        const settingsPhoneInput = document.getElementById('settings-phone'); // NEW REF
        const settingsNameInput = document.getElementById('settings-name'); 
        const settingsAgeInput = document.getElementById('settings-age'); 
        const settingsFaithSelect = document.getElementById('settings-faith'); 
        const settingsWillpowerInput = document.getElementById('settings-willpower'); 
        const settingsFocusInput = document.getElementById('settings-focus'); 
        const settingsPurposeTextarea = document.getElementById('settings-purpose'); 
        const editProfileBtn = document.getElementById('edit-profile-btn'); // NEW REF
        const settingsSaveBtn = document.getElementById('settings-save-btn'); // NEW REF
        const settingsCancelBtn = document.getElementById('settings-cancel-btn'); // NEW REF


        // --- Persistence & Storage Functions ---
        
        function loadSkills() {
             try {
                const stored = localStorage.getItem(SKILLS_KEY);
                const unlockedIds = stored ? JSON.parse(stored) : [];
                
                // Initialize PLAYER_SKILLS array with full definitions
                PLAYER_SKILLS = ALL_PLAYER_SKILLS.map(skill => ({
                    ...skill,
                    unlocked: unlockedIds.includes(skill.id)
                }));
            } catch (error) {
                console.error("Error loading skills from localStorage:", error);
                PLAYER_SKILLS = ALL_PLAYER_SKILLS;
            }
        }

        function saveSkills() {
            try {
                localStorage.setItem(SKILLS_KEY, JSON.stringify(PLAYER_SKILLS.filter(s => s.unlocked).map(s => s.id)));
            } catch (error) {
                console.error("Error saving skills to localStorage:", error);
            }
        }

        function unlockSkill(skillId) {
            const skill = PLAYER_SKILLS.find(s => s.id === skillId);
            if (skill && !skill.unlocked) {
                skill.unlocked = true;
                saveSkills();
                updateUI();
                return true;
            }
            return false;
        }

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error("Error loading progress from localStorage:", error);
                return {};
            }
        }

        function saveProgress(progress) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
            } catch (error) {
                console.error("Error saving progress to localStorage:", error);
            }
        }

        function loadCharacter() {
            try {
                const stored = localStorage.getItem(CHARACTER_KEY);
                // Ensure default values for new fields when loading old data
                const char = stored ? JSON.parse(stored) : null;
                if (char) {
                    char.charRealName = char.charRealName || '';
                    char.charCity = char.charCity || '';
                    char.charSource = char.charSource || '';
                    char.charPhone = char.charPhone || ''; // NEW
                    char.charAge = char.charAge || 0; // Ensure age exists
                }
                return char;
            } catch (error) {
                console.error("Error loading character from localStorage:", error);
                return null;
            }
        }

        function saveCharacter(characterData) {
            try {
                localStorage.setItem(CHARACTER_KEY, JSON.stringify(characterData));
            } catch (error) {
                console.error("Error saving character to localStorage:", error);
            }
            // Log character data when saved/updated
            logDataToSheet(characterData, 'Profile');
        }

        function loadLogs() {
            try {
                const stored = localStorage.getItem(LOG_HISTORY_KEY);
                // Ensure every log has a unique ID for battle tracking
                const logs = stored ? JSON.parse(stored) : [];
                return logs.map(log => ({ 
                    ...log, 
                    id: log.id || crypto.randomUUID(),
                    // Ensure monsterCurrentHP exists on old logs, defaulting to maxHealth
                    monsterCurrentHP: log.monsterCurrentHP || log.monsterHealth || 0 // CRITICAL: Backfill missing field
                }));
            } catch (error) {
                console.error("Error loading logs from localStorage:", error);
                return [];
            }
        }

        function saveLog(logEntry) {
            try {
                const logs = loadLogs();
                // Find existing log entry by ID and replace it, or unshift the new one
                const existingIndex = logs.findIndex(log => log.id === logEntry.id);
                if (existingIndex !== -1) {
                    logs[existingIndex] = logEntry;
                } else {
                    logs.unshift(logEntry); // Add new log to the beginning (most recent first)
                }
                
                // CRITICAL FIX: The error is here. Large media files (proofDataURL) saved previously exceeded the quota.
                // We must remove the dataURL property before saving to prevent future quota errors.
                // We ensure the temporary proofDataURL is removed but type/text is kept.
                const logsToSave = logs.map(log => ({
                    ...log,
                    tasks: log.tasks ? log.tasks.map(task => ({ // Check if tasks property exists
                        ...task,
                        // Ensure large data URL is not persisted, but icon metadata is safe
                        proofDataURL: undefined 
                    })) : [], // If no tasks, save empty array
                }));

                localStorage.setItem(LOG_HISTORY_KEY, JSON.stringify(logsToSave));

                // Log the full log entry to the Google Sheet (LogSheet)
                logDataToSheet(logEntry, 'Logs');

                return logs;
            } catch (error) {
                console.error("Error saving log to localStorage:", error);
                // Return the logs we tried to save to maintain in-memory state, even if persistence failed
                return logs;
            }
        }
        
        function getLogById(id) {
             const logs = loadLogs();
             return logs.find(log => log.id === id);
        }

        /** Helper function to get the checked radio button value by name */
        function getRadioValue(name) {
            const radio = document.querySelector(`input[name="${name}"]:checked`);
            return radio ? radio.value : '';
        }

        /** Implements the custom logic to calculate the character's base stats based on profile inputs. */
        function calculateBaseStats(formData) {
            const { 
                name, realName, city, source, phone, age, willpower, focus, faith, purpose, quitCount,
                triggers, motives
            } = formData;
            
            // Get values from hidden radio buttons
            const addiction = getRadioValue('char-addiction');
            const interfere = getRadioValue('char-interfere');
            const guiltShame = getRadioValue('char-guilt-shame');
            const support = getRadioValue('char-support');
            const frequency = document.getElementById('char-frequency').value;
            const timeSince = document.getElementById('char-time-since').value;


            // --- Base Stat Initialization ---
            let calculatedHP = 100;
            let calculatedMotivation = 5;
            let calculatedWillpower = parseInt(willpower) || 3;
            let calculatedFocus = parseInt(focus) || 3;
            const addictionLevel = { mild: 1, moderate: 2, severe: 3 }[addiction] || 1;
            
            // --- 1. HP & DEFENSE Penalties/Bonuses ---
            
            // A. Guilt/Shame Penalty for HP
            const guiltPenalty = (parseInt(guiltShame) || 1) * 3; // 1-5 scale -> 3 to 15 penalty
            calculatedHP -= guiltPenalty;


            // B. Addiction Penalty (Applies to HP and Defense)
            if (addiction === 'moderate') { calculatedHP -= 10; }
            if (addiction === 'severe') { calculatedHP -= 20; }

            // C. Support System Bonus (Applies to HP and Defense)
            let calculatedDefense = 5; // Base Defense
            if (support === 'strong') { 
                calculatedHP += 20; // Health Boost
                calculatedDefense += 3; // Defense Boost
            } else if (support === 'moderate') {
                calculatedDefense += 1;
            }

            // D. Defense Calculation (Base 5 + Age Factor + Support Bonus - Addiction Penalty * 2)
            calculatedDefense += Math.floor(age / 20) || 0; // Minor age factor
            calculatedDefense -= (addictionLevel * 2);
            calculatedDefense = Math.max(1, calculatedDefense); // Defense floor of 1


            // --- 2. WILLPOWER & FOCUS Adjustments ---

            // A. Quit Count Penalty (Burnout)
            const quitPenalty = Math.floor(quitCount / 3);
            if (quitCount > 0) {
                 calculatedWillpower = Math.max(1, calculatedWillpower - quitPenalty);
                 calculatedFocus = Math.max(1, calculatedFocus - quitPenalty);
            }
            
            // B. Time Since Last Urge Bonus (Reflects recent stability)
            if (timeSince === 'weeks') {
                calculatedWillpower += 1;
                calculatedFocus += 1;
            } else if (timeSince === 'months') {
                calculatedWillpower += 2;
                calculatedFocus += 2;
            }
            calculatedWillpower = Math.min(10, calculatedWillpower);
            calculatedFocus = Math.min(10, calculatedFocus);

            // C. Urge Frequency Bonus for Defense
            if (frequency === 'weekly' || frequency === 'less') {
                calculatedDefense += 1; 
            }


            // --- 3. MOTIVATION & SPECIAL ---

            // A. Daily Life Interference Penalty for Motivation
            if (interfere === 'yes') { calculatedMotivation -= 2; }

            // B. Hero's Purpose/Motivation Count Bonus
            if (motives.length >= 2) { 
                calculatedMotivation += 2; 
            }
            if (purpose && purpose.length > 10) { 
                calculatedMotivation += 1; 
            } 
            calculatedMotivation = Math.max(1, calculatedMotivation);

            // C. Special Attribute
            const calculatedSpecial = (faith === 'yes') ? 'Inner Light' : 'None';

            // D. XP Bonus for Time Since Relapse
            let calculatedXP = 0;
            if (timeSince === 'months') {
                calculatedXP = 100;
            }

            return {
                charName: name,
                charRealName: realName, 
                charCity: city, 
                charSource: source, 
                charPhone: phone, // NEW
                charAge: age, 
                charLevel: 1,
                charHP: Math.max(40, calculatedHP), // Minimum HP is 40 for severe cases
                charXP: calculatedXP,
                charWillpower: calculatedWillpower,
                charFocus: calculatedFocus,
                charMotivation: calculatedMotivation,
                charDefense: calculatedDefense,
                charSpecial: calculatedSpecial,
                charPurpose: purpose, // Storing purpose on the character object
            };
        }


        // --- Monster Progression Logic ---
        function getTriggerType(triggerText) {
            const normalizedText = triggerText.toLowerCase();
            const found = TRIGGER_MAP.find(map => normalizedText.includes(map.keyword));
            return found ? { type: found.type, emoji: found.emoji } : { type: 'Unclassified Monster', emoji: '❓' };
        }
        
        /**
         * Calculates monster stats dynamically based on player stats for difficulty scaling.
         */
        function calculateMonsterStats(stage, tasksMultiplier, playerHP, playerWillpower, playerFocus) {
            
            const basePlayerStat = (playerWillpower + playerFocus) / 2;
            const healthDifficultyFactor = [1.0, 1.25, 1.5]; // Multiplier for HP across stages
            const damageDifficultyFactor = [1.0, 1.3, 1.6];  // Multiplier for Damage across stages
            
            // --- Health Rebalancing Fix ---
            // Base Health is now much lower and relies more heavily on player stats to keep it manageable.
            // Adjusted calculation to make monsters beatable for new players (stage 1 target HP is around 80-120).
            let baseHealth = (basePlayerStat * 8) + (playerHP * 0.2); 
            
            // Add randomness and apply stage multiplier
            let monsterHealth = Math.round(
                baseHealth * healthDifficultyFactor[stage - 1] * (0.9 + Math.random() * 0.2) // +/- 10% randomness
            );
            
            // Ensure a minimum base health for starting stages.
            const minMonsterHealth = (stage === 1) ? 80 : 110;
            
            // Ensure monster is not ridiculously easy or impossible
            monsterHealth = Math.max(monsterHealth, minMonsterHealth);
            
            // Upper cap to prevent insanity (Monster HP should not exceed player's HP by much for stage 1)
            monsterHealth = Math.min(monsterHealth, playerHP * 1.5);

            // --- MONSTER DAMAGE LOGIC UPDATE (Requested Fix: Match power to character stats) ---
            // Instead of multiplying a fixed value (e.g., skill.damage * factor), 
            // the skill's base damage is scaled to the player's primary damage-dealing stats (Willpower/Focus)
            // and the stage difficulty factor.

            // Target effective monster damage should be roughly 10-20% of player max HP per hit for balanced gameplay.
            const targetDamagePerHit = playerHP * 0.15; 
            const playerAttackStat = (playerWillpower * 0.5) + (playerFocus * 0.5); // Average important stat

            // Base damage is scaled by the player's attack power inversely, ensuring monster damage relative to player's capacity
            // This ensures a 10 Willpower player faces a monster that can still hurt them.
            // Damage range is now set around the targetDamagePerHit, scaled by the difficulty factor.
            let monsterBaseDamage = Math.round(
                targetDamagePerHit * damageDifficultyFactor[stage - 1] * (0.8 + Math.random() * 0.4) // +/- 20% randomness
            );

            // Ensure base damage isn't zero
            monsterBaseDamage = Math.max(10, monsterBaseDamage); 


            return {
                health: monsterHealth,
                // Pass the calculated base damage for all skills
                damageFactor: 1.0, // Damage factor is now incorporated into the monsterBaseDamage calculation
                baseDamage: monsterBaseDamage,
            };
        }


        function getMonsterByCount(triggerType, winCount) {
            const progression = MONSTER_PROGRESSION[triggerType] || MONSTER_PROGRESSION['Unclassified Monster'];
            
            let stageIndex = 0;
            if (winCount >= 1 && winCount <= 2) {
                stageIndex = 1;
            } else if (winCount >= 3) {
                stageIndex = 2;
            }

            const monsterConfig = progression[Math.min(stageIndex, progression.length - 1)];
            
            // Determine the base emoji (used for Stage 1)
            const baseEmoji = TRIGGER_MAP.find(map => map.type === triggerType)?.emoji || '❓';
            let monsterEmoji = baseEmoji;

            // NEW FEATURE: Override emoji based on stage (Evolve the monster's appearance)
            if (monsterConfig.stage === 2) {
                if (triggerType === 'Loneliness') monsterEmoji = '👻'; 
                else if (triggerType === 'Boredom') monsterEmoji = '🥱'; 
                else if (triggerType === 'Stress/Anxiety') monsterEmoji = '🥵'; 
                else if (triggerType === 'Late Night Urge') monsterEmoji = '🦇'; 
                else if (triggerType === 'Media/Phone Triggers') monsterEmoji = '🔗'; 
                else if (triggerType === 'Curiosity') monsterEmoji = '🐍'; 
                else if (triggerType === 'Rejection/Failure') monsterEmoji = '🥀'; 
                else monsterEmoji = '👺';
            } else if (monsterConfig.stage === 3) {
                if (triggerType === 'Loneliness') monsterEmoji = '💀'; 
                else if (triggerType === 'Boredom') monsterEmoji = '👾'; 
                else if (triggerType === 'Stress/Anxiety') monsterEmoji = '🌋'; 
                else if (triggerType === 'Late Night Urge') monsterEmoji = '😈';
                else if (triggerType === 'Media/Phone Triggers') monsterEmoji = '🤖'; 
                else if (triggerType === 'Curiosity') monsterEmoji = '🌀';
                else if (triggerType === 'Rejection/Failure') monsterEmoji = '🖤'; 
                else monsterEmoji = '👹';
            }


            const calculatedStats = calculateMonsterStats(
                stageIndex + 1, 
                monsterConfig.tasks_multiplier, 
                gameState.charHP, 
                gameState.charWillpower, 
                gameState.charFocus
            );

            // Calculate skill-specific damage based on the dynamically scaled base damage
            const scaledSkills = monsterConfig.skills.map(skill => {
                 let skillMultiplier = 1.0;
                 if (skill.name.includes('(Weak)')) skillMultiplier = 0.8;
                 else if (skill.name.includes('(Crit)')) skillMultiplier = 1.2;
                 
                 // If the skill is purely an effect (damage=0 in config), keep it at 0
                 const finalDamage = skill.damage === 0 ? 0 : Math.round(calculatedStats.baseDamage * skillMultiplier);

                 return {
                     ...skill,
                     damage: Math.max(0, finalDamage)
                 };
            });


            return { 
                ...monsterConfig, 
                isElite: winCount >= 3,
                // Use dynamically calculated health
                health: calculatedStats.health, 
                stage: stageIndex + 1,
                // NEW: Use the updated emoji
                monsterEmoji: monsterEmoji,
                tasks_multiplier: monsterConfig.tasks_multiplier, 
                skills: scaledSkills,
            };
        }
        
        /**
         * Selects tasks relevant to the trigger type and generates a new list of quests.
         */
        function calculateTasksForMonster(monsterHealth, triggerType, tasksMultiplier = 1.0) {
            
            const targetPower = monsterHealth; // Target power equal to monster health for a fair fight
            
            // Select tasks specific to the monster's trigger, fall back to ALL if none exist (shouldn't happen now)
            const availableQuests = TRIGGER_SPECIFIC_QUESTS[triggerType] || ALL_QUESTS;
            
            // Randomly shuffle the list of available tasks to ensure variety
            let shuffledQuests = [...availableQuests].sort(() => 0.5 - Math.random());
            
            let currentPower = 0;
            let assignedQuests = [];
            
            // Max number of tasks is 10, minimum is 5.
            const maxTasks = 10; 
            const minTasks = 5;

            // Calculate how many tasks we *need* based on the tasksMultiplier (e.g., 1.5x quests on loss)
            // Use Math.ceil to ensure we round up.
            const requiredPowerWithMultiplier = Math.ceil(targetPower * tasksMultiplier);
            
            // 1. Fill tasks until the target power is met or max tasks reached
            let i = 0;
            while (currentPower < requiredPowerWithMultiplier && assignedQuests.length < maxTasks && i < shuffledQuests.length) {
                const quest = shuffledQuests[i];
                assignedQuests.push(quest);
                currentPower += quest.value;
                i++;
            }
            
            // 2. Fallback: Ensure minimum number of tasks are present if total power is still too low
            while (assignedQuests.length < minTasks) {
                 const fallbackQuest = ALL_QUESTS[Math.floor(Math.random() * ALL_QUESTS.length)];
                 assignedQuests.push(fallbackQuest);
                 currentPower += fallbackQuest.value;
            }

            // Map to the log format
            return assignedQuests.map(q => ({ ...q, completed: false }));
        }


        // --- General Utility Functions ---

        function closeGeneralModal() { generalModal.classList.add('hidden'); }
        
        function closeProofModal() { 
            proofModal.classList.add('hidden'); 
            // Reset the dynamic fields when closing
            proofTypeSelect.value = "";
            handleProofTypeChange(""); // Correctly reset dynamic visibility and required fields
        }

        // Updated resetGame to use localStorage.clear()
        function resetGame() { 
            localStorage.clear();
            // Log data reset to the sheet
            logDataToSheet({ charName: gameState.charName, reason: 'Game Reset' }, 'Admin');
            window.location.reload(); 
        }

        function handleProofTypeChange(type) {
            fileProofContainer.classList.add('hidden');
            textProofContainer.classList.add('hidden');
            proofFileInput.value = '';
            proofTextarea.value = '';
            
            // Reset proof preview text
            proofPreview.innerHTML = type === 'file' ? 'Upload your file...' : 'Select a proof file (image, video, voice) or enter text...';


            // Toggle visibility and required status
            if (type === 'file') {
                fileProofContainer.classList.remove('hidden');
                proofFileInput.setAttribute('required', 'required');
                proofTextarea.removeAttribute('required');
            } else if (type === 'text') {
                textProofContainer.classList.remove('hidden');
                proofTextarea.setAttribute('required', 'required');
                proofFileInput.removeAttribute('required');
            } else {
                proofFileInput.removeAttribute('required');
                proofTextarea.removeAttribute('required');
            }
        }


        // NEW: Show Message Function (Modal or Box)
        function showGeneralModal(title, message) {
            generalModalTitle.textContent = title;
            generalModalMessage.innerHTML = message;
            generalModal.classList.remove('hidden');
        }

        function showMessage(text, type) {
            messageBox.classList.remove('hidden', 'bg-blue-600', 'bg-success', 'bg-danger', 'bg-yellow-600');
            messageText.innerHTML = text;
            resetButton.classList.add('hidden');

            switch (type) {
                case 'info':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-blue-600';
                    break;
                case 'success':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-success';
                    break;
                case 'danger':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-danger';
                    break;
                case 'win':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-yellow-600';
                    resetButton.classList.remove('hidden');
                    break;
            }
        }
        
        // --- Character Creation UI Logic ---

        function updateCreationStepUI() {
            const currentStep = parseInt(currentStepInput.value);
            const totalSteps = stepElements.length;

            const stepTitles = [
                "Your Identity & Personal Details",
                "Assessing the Battlefield (Core Stats & Addiction Details)",
                "Triggers & Resources",
                "The Hero's Oath"
            ];
            const stepSubtitles = [
                "Enter your personal details and select your alias.",
                "Set your base Willpower and Focus, and detail your usage history to gauge the conflict.",
                "Identify external triggers and your current support network.",
                "Define your core motivation and immediate goals for the journey ahead."
            ];

            creationTitle.textContent = `${stepTitles[currentStep - 1]} (${currentStep}/${totalSteps})`;
            creationSubtitle.textContent = stepSubtitles[currentStep - 1];

            // Show/hide steps
            stepElements.forEach((id, index) => {
                document.getElementById(id).classList.add('hidden');
                if (index + 1 === currentStep) {
                    document.getElementById(id).classList.remove('hidden');
                }
            });

            // Update navigation buttons
            prevBtn.disabled = currentStep === 1;
            prevBtn.classList.toggle('opacity-50', currentStep === 1);
            prevBtn.classList.toggle('cursor-not-allowed', currentStep === 1);

            nextBtn.classList.toggle('hidden', currentStep === totalSteps);
            submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
        }
        
        function validateStep(step) {
            const stepElement = document.getElementById(`step-${step}`);
            let isValid = true;
            
            // Reset custom error classes
            const radioGroups = stepElement.querySelectorAll('.radio-group-error');
            radioGroups.forEach(group => group.classList.remove('radio-group-error'));
            
            // 1. Validate standard required fields
            const inputs = Array.from(stepElement.querySelectorAll('input[required], select[required], textarea[required]'));
            inputs.forEach(input => {
                // Skip radio buttons from basic check, they are handled below
                if (input.type === 'radio') return;
                
                // CRITICAL FIX: Add specific check for phone number to ensure it only contains digits, even though oninput handles live input
                if (input.id === 'char-phone' && !/^\d*$/.test(input.value)) {
                    input.setCustomValidity('Phone number must contain only digits.');
                } else if (input.id === 'char-phone') {
                    input.setCustomValidity(''); // Clear custom error if valid
                }

                if (!input.value.trim() || !input.checkValidity()) {
                    isValid = false;
                }
            });
            
            // 2. Custom Radio Group Validation (Step 2 and Step 3)
            const radioGroupChecks = {
                2: ['char-addiction', 'char-interfere', 'char-guilt-shame'],
                3: ['char-support']
            };

            if (radioGroupChecks[step]) {
                radioGroupChecks[step].forEach(groupName => {
                    const groupContainerId = groupName.replace('char-', '') + '-group';
                    const groupElement = document.getElementById(groupContainerId);
                    
                    // CRITICAL FIX: Check if ANY radio button in the group is checked
                    const isChecked = document.querySelector(`input[name="${groupName}"]:checked`);
                    
                    if (!isChecked) {
                        if (groupElement) groupElement.classList.add('radio-group-error');
                        isValid = false;
                    } else {
                         // Ensure successful selection removes the error class
                        if (groupElement) groupElement.classList.remove('radio-group-error');
                    }
                });
            }
            
            if (!isValid) {
                 // Removed showMessage here to prevent multiple error alerts during bulk validation
                 return false;
            }
            
            return true;
        }

        function navigateStep(direction) {
            const currentStep = parseInt(currentStepInput.value);
            const totalSteps = stepElements.length;
            
            if (direction === 1) {
                // Only validate the current step before moving forward
                if (!validateStep(currentStep)) {
                     showMessage('Please complete all required fields on the current step to continue.', 'danger');
                     return; 
                }
            }

            const newStep = currentStep + direction;
            
            if (newStep >= 1 && newStep <= totalSteps) {
                currentStepInput.value = newStep;
                updateCreationStepUI();
            }
        }


        // --- Dashboard & Rendering Logic ---

        function changeDashboardView(view) {
            gameState.dashboardView = view;
            // CRITICAL FIX: Explicitly set activeLogId to null when switching to non-battle views
            if (view !== 'battle' && view !== 'active-battle') { 
                gameState.activeLogId = null;
            }
            updateUI();
        }

        function renderDashboard() {
            renderCharacterStats();
            setLogDateToToday();
            setupLogActionListeners();
        }
        
        // NEW FEATURE: Level Up Check
        function checkLevelUp() {
            if (gameState.charXP >= XP_TO_LEVEL_UP) {
                gameState.charLevel++;
                gameState.charXP -= XP_TO_LEVEL_UP; // Remaining XP carries over

                // Permanent Stat Boosts
                gameState.charHP += 10;
                gameState.charWillpower = Math.min(10, gameState.charWillpower + 1);
                gameState.charFocus = Math.min(10, gameState.charFocus + 1);
                gameState.charDefense = Math.min(15, gameState.charDefense + 1);

                saveCharacter(gameState);
                
                showGeneralModal('✨ LEVEL UP!', 
                    `You reached **Sentinel Level ${gameState.charLevel}**!
                    <br><br>
                    **Permanent Gains:**
                    <ul>
                        <li>+10 Max HP</li>
                        <li>+1 Willpower</li>
                        <li>+1 Focus</li>
                        <li>+1 Defense</li>
                    </ul>
                    The next level target is **${XP_TO_LEVEL_UP} XP**.`);
                
                // Log level up event
                logDataToSheet({ charName: gameState.charName, newLevel: gameState.charLevel }, 'LevelUps');

                // Re-check in case user gained enough XP to skip multiple levels
                if (gameState.charXP >= XP_TO_LEVEL_UP) {
                    checkLevelUp();
                }
            }
        }

        function renderCharacterStats() {
            const char = gameState;
            let currentWeapon = 'Wooden Club 🪵';
            let currentArmor = 'Rags';
            let aura = 'gray-500';

            // Simple visual progression based on XP/Level
            if (char.charLevel >= 3) {
                currentWeapon = 'Radiant Blade ✨';
                currentArmor = 'Full Plate';
                aura = 'yellow-400';
            } else if (char.charLevel >= 2) {
                currentWeapon = 'Iron Sword ⚔️';
                currentArmor = 'Steel Armor';
                aura = 'blue-500';
            }

            // Avatar Container
            avatarContainer.innerHTML = `
                <p class="text-6xl mb-2">${char.charSpecial === 'Inner Light' ? '✨' : ''} 🥷</p>
                <p class="text-lg font-bold text-${aura} text-shadow">${char.charName}</p>
                <p class="text-sm text-slate-400">${currentArmor} & ${currentWeapon}</p>
            `;

            // Stats Panel
            statsPanel.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <p class="font-semibold text-primary">Level:</p><p class="text-text-light">${char.charLevel}</p>
                    <p class="font-semibold text-primary">HP (Max):</p><p class="text-text-light">${char.charHP}</p>
                    <p class="font-semibold text-primary">Willpower:</p><p class="text-text-light">${char.charWillpower} / 10</p>
                    <p class="font-semibold text-primary">Focus:</p><p class="text-text-light">${char.charFocus} / 10</p>
                    <p class="font-semibold text-primary">Defense:</p><p class="text-text-light">${char.charDefense}</p>
                    <p class="font-semibold text-primary">Motivation:</p><p class="text-text-light">${char.charMotivation} / 10</p>
                </div>
                <div class="mt-3 pt-3 border-t border-slate-600 space-y-1">
                    <p class="text-xs font-semibold text-secondary">XP Progress: ${char.charXP} / ${XP_TO_LEVEL_UP} XP</p>
                    <div class="progress-bar-container h-2">
                        <div class="progress-bar bg-success" style="width: ${Math.min(100, (char.charXP / XP_TO_LEVEL_UP) * 100)}%;"></div>
                    </div>
                    <p class="text-xs text-slate-400">Next Level: ${XP_TO_LEVEL_UP - char.charXP} XP required</p>
                </div>
            `;
        }
        
        function renderLogHistory(filteredLogs = null) {
            const logs = filteredLogs || loadLogs();
            if (logs.length === 0) {
                logHistoryContainer.innerHTML = '<p class="text-slate-400 text-sm">No impulse logs recorded yet.</p>';
                return;
            }

            logHistoryContainer.innerHTML = logs.map(log => {
                const statusClass = log.status === 'Defeated' ? 'border-success' : log.status === 'Lost' ? 'border-danger' : log.status === 'Active' ? 'border-secondary' : 'border-slate-500';
                const statusEmoji = log.status === 'Defeated' ? '✅' : log.status === 'Lost' ? '❌' : '⚔️';
                
                // Use log's specific emoji
                const monsterCard = log.monsterName ? 
                    `<span class="font-semibold text-text-light">${log.monsterEmoji} ${log.monsterName} (Stage ${log.monsterStage})</span>` :
                    `<span class="font-semibold text-text-light">No Monster Spawned</span>`;

                const completedTasks = log.tasks.filter(t => t.completed);
                const taskDetails = completedTasks.map(t => {
                    let proofIcon = '📝';
                    
                    // CRITICAL FIX: Use large icons for visual confirmation of proof type.
                    if (t.proofType === 'image') {
                        proofIcon = '🖼️';
                    } else if (t.proofType === 'video') {
                        proofIcon = '🎬';
                    } else if (t.proofType === 'audio') {
                        proofIcon = '🎤';
                    }
                    
                    const proofText = t.proofText ? `<p class="text-xs text-slate-300 italic">"${t.proofText.substring(0, 50)}..."</p>` : '';

                    return `
                        <div class="flex items-center text-xs text-success/80 bg-slate-700/50 p-2 rounded-lg">
                            <span class="proof-icon mr-2">${proofIcon}</span>
                            <div>
                                <p class="font-medium">${t.name}</p>
                                ${proofText}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="log-entry ${statusClass} bg-slate-700/50">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="text-slate-400">${log.logDate} @ ${log.logTime}</span>
                            <span class="font-bold ${log.status === 'Defeated' ? 'text-success' : log.status === 'Lost' ? 'text-danger' : 'text-secondary'}">${statusEmoji} ${log.status}</span>
                        </div>
                        <p class="text-text-light mb-2">Trigger: ${log.triggerType} - ${log.triggerSpecific}</p>
                        
                        ${log.monsterName ? `<p class="text-sm mb-2">${monsterCard}</p>` : ''}

                        <div class="mt-3 border-t border-slate-600 pt-3">
                            <p class="font-semibold text-slate-300">Outcome: <span class="font-normal text-text-light">${log.actionTaken}</span></p>
                            ${log.actionTaken !== 'Gave In' && completedTasks.length > 0 ? 
                                `<p class="font-semibold text-slate-300 mt-2">💪 Tasks Completed:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1">${taskDetails}</div>` : 
                                log.actionTaken === 'Gave In' ? `<p class="text-danger mt-2">Aftermath: ${log.afterFeelings}</p>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // NEW FEATURE: Date Filter Logic
        function filterLogHistory() {
            const startDate = dateStartFilter.value;
            const endDate = dateEndFilter.value;
            const allLogs = loadLogs();
            
            let filteredLogs = allLogs;
            
            if (startDate) {
                const start = new Date(startDate);
                filteredLogs = filteredLogs.filter(log => new Date(log.logDate) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                // Filter up to the end of the selected day
                end.setDate(end.getDate() + 1); 
                filteredLogs = filteredLogs.filter(log => new Date(log.logDate) < end);
            }
            
            renderLogHistory(filteredLogs);
        }

        function resetLogFilter() {
             dateStartFilter.value = '';
             dateEndFilter.value = '';
             filterLogHistory(); // Renders all logs
        }


        function renderMonsterHistory() {
            // Filter out 'Active' logs, as they are now displayed separately
            const allLogs = loadLogs().filter(log => log.status !== 'Active'); 
            
            const pastEncounters = allLogs.filter(log => log.status === 'Defeated' || log.status === 'Lost');

            if (pastEncounters.length === 0) {
                monsterHistoryContainer.innerHTML = '<p class="text-slate-400 text-sm">No completed or lost encounters recorded yet.</p>';
                return;
            }

            monsterHistoryContainer.innerHTML = pastEncounters.map(log => {
                let statusClass = 'border-slate-500';
                let statusText = 'Logged';
                
                if (log.status === 'Defeated') {
                    statusClass = 'border-success';
                    statusText = '✅ DEFEATED';
                } else if (log.status === 'Lost') {
                    statusClass = 'border-danger';
                    statusText = '❌ LOST BATTLE';
                }

                return `
                    <div class="app-card p-4 flex justify-between items-center border ${statusClass} transition duration-200 bg-slate-700/50 no-hover">
                        <div class="space-y-1">
                            <h4 class="text-lg font-bold text-text-light">${log.monsterEmoji} ${log.monsterName} (Stage ${log.monsterStage})</h4>
                            <p class="text-xs text-slate-400">Trigger: ${log.triggerType} | Logged: ${log.logDate}</p>
                            <p class="text-sm font-semibold ${log.status === 'Defeated' ? 'text-success' : 'text-danger'}">${statusText}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-slate-400">Power: ${log.currentPower}/${log.monsterHealth}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderBattleLogList() {
            // Filter only Active encounters for the list view
            const activeLogs = loadLogs().filter(log => log.status === 'Active');
            
            if (activeLogs.length === 0) {
                monsterListContainer.innerHTML = '<p class="text-slate-400 text-sm">No active impulse threats. Log an impulse to begin an encounter!</p>';
                return;
            }

            monsterListContainer.innerHTML = activeLogs.map(log => {
                const monster = log.monsterName;
                const power = log.currentPower;
                const required = log.monsterHealth;
                const currentHP = log.monsterCurrentHP; // Get current HP for visual damage
                
                // Ensure currentHP is not greater than max health
                const healthPct = Math.min(100, (currentHP / required) * 100); 
                const powerPct = Math.min(100, (power / required) * 100); 

                return `
                    <div class="app-card p-4 flex justify-between items-center battle-card transition duration-200 cursor-pointer ${gameState.activeLogId === log.id ? 'battle-active' : ''}" onclick="viewActiveBattle('${log.id}')">
                        <div class="space-y-1">
                            <h4 class="text-lg font-bold text-secondary">${log.monsterEmoji} ${monster}</h4>
                            <p class="text-xs text-slate-400">Stage ${log.monsterStage} | Current HP: ${Math.max(0, currentHP)}</p>
                        </div>
                        <div class="w-1/2 ml-4 space-y-1">
                            <div class="progress-bar-container h-2 bg-danger">
                                <div class="progress-bar bg-danger/50" style="width: ${healthPct}%;"></div>
                            </div>
                            <div class="progress-bar-container h-2">
                                <div class="progress-bar bg-yellow-500" style="width: ${powerPct}%;"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-text-light">${power} / ${required} Power</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewActiveBattle(logId) {
            if (logId === null) {
                // If logId is null, go back to the list view
                gameState.activeLogId = null;
            } else {
                 // If logId is provided, view that specific battle
                gameState.activeLogId = logId;
            }
            gameState.dashboardView = 'battle';
            updateUI(); // Re-render to show the correct battle/list view
        }

        function renderBattleState() {
            const log = getLogById(gameState.activeLogId);
            
            // CRITICAL FIX: If log is missing or defeated, reset to list view
            if (!log || log.status === 'Defeated') { 
                gameState.activeLogId = null;
                activeBattleView.classList.add('hidden');
                battleLogList.classList.remove('hidden');
                document.getElementById('encounter-history-list').classList.remove('hidden'); // Show history title
                renderBattleLogList();
                renderMonsterHistory(); 
                return; 
            }

            // --- Render Individual Battle View ---
            battleLogList.classList.add('hidden');
            document.getElementById('encounter-history-list').classList.add('hidden'); // Hide the history section title
            activeBattleView.classList.remove('hidden');
            activeBattleTitle.textContent = log.monsterName;

            const powerPct = (log.currentPower / log.monsterHealth) * 100;
            powerBar.style.width = `${powerPct}%`;
            powerText.textContent = `🛡️ Quests Completed Power: ${log.currentPower} / ${log.monsterHealth}`;
            
            // Battle is always possible now
            const readyToLaunch = true; 
            
            launchBattleButton.onclick = launchTurnBasedBattle;
            
            if (log.currentPower >= 100) {
                 attackStatusMessage.innerHTML = `<span class="text-success font-semibold">Ready to Attack! Power ${log.currentPower} / ${log.monsterHealth}.</span>`;
                 launchBattleButton.classList.remove('bg-danger/50');
                 launchBattleButton.classList.add('bg-secondary');
            } else {
                 attackStatusMessage.innerHTML = `<span class="text-yellow-400">Complete quests to reach 100+ Power to launch battle.</span>`;
                 launchBattleButton.classList.add('bg-danger/50');
                 launchBattleButton.classList.remove('bg-secondary');
            }

            // Monster Display Card
            monsterDisplay.innerHTML = `
                <p class="text-7xl">${log.monsterEmoji}</p>
                <h4 class="text-2xl font-bold text-danger">${log.monsterName}</h4>
                <p class="text-sm text-slate-400">Stage ${log.monsterStage} | Health: ${log.monsterHealth} (Current: ${Math.max(0, log.monsterCurrentHP)})</p>
                <div class="mt-2 p-2 bg-slate-700 rounded-lg text-left">
                    <p class="text-xs font-semibold text-yellow-400">Active Skills:</p>
                    ${log.monsterSkills.map(s => `<p class="text-xs text-slate-300 ml-2">- ${s.name} (Effect: ${s.effect}, Damage: ${s.damage})</p>`).join('')}
                </div>
            `;

            renderTasks(log);
        }
        
        // NEW FEATURE: Task Guide Logic
        function showTaskGuide(taskName, description, instructions, proof) {
            const content = `
                <h4 class="text-lg font-bold text-secondary mb-2">${taskName}</h4>
                <p class="text-sm text-text-light mb-4">${description}</p>
                <div class="p-3 bg-slate-800 rounded-lg space-y-2 text-left">
                    <p class="font-semibold text-primary">Instructions:</p>
                    <p class="text-sm text-text-light">${instructions}</p>
                    <p class="font-semibold text-primary pt-2 border-t border-slate-700">Proof Required:</p>
                    <p class="text-sm text-text-light">${proof}</p>
                </div>
                <p class="text-xs text-yellow-400 mt-3">Click 'Acknowledge' to close, then click the 'Submit Proof' button on the Quest card once done.</p>
            `;
            showGeneralModal('📘 Quest Guide', content);
        }


        /**
         * Utility function to escape single quotes and backslashes for use within a single-quoted JS string literal in HTML.
         * @param {string} str The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeForJsString(str) {
            if (!str) return '';
            // Escape backslashes first to prevent them from escaping the quote characters in the next step.
            // Then escape single quotes, as they are used to wrap the JS function arguments in HTML.
            return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }


        function renderTasks(log) {
            // Render the dynamically generated tasks for this specific log entry
            tasksList.innerHTML = log.tasks.map(quest => {
                const isCompleted = quest.completed;
                const buttonClass = isCompleted ? 'bg-success/50 cursor-default' : 'bg-primary hover:bg-primary/90';
                const buttonText = isCompleted ? '✅ Proof Submitted' : `Submit Proof (+${quest.value} Power)`;
                
                // Find full task details for the guide
                const allQuests = Object.values(TRIGGER_SPECIFIC_QUESTS).flat();
                // FIX: Look up the quest details using the ID stored in the log entry.
                const fullQuest = allQuests.find(q => q.id === quest.id) || {
                    description: quest.description, // Fallback to log description if full entry missing
                    instructions: 'Instructions missing. Please refer to your recovery plan.', 
                    proof: 'Submit text proof describing your completion.'
                };
                
                // --- FIX: Use robust escaping for HTML attribute injection ---
                const cleanName = escapeForJsString(quest.name);
                const cleanDescription = escapeForJsString(fullQuest.description);
                const cleanInstructions = escapeForJsString(fullQuest.instructions);
                const cleanProof = escapeForJsString(fullQuest.proof);


                // Action for 'Submit Proof' button
                const action = isCompleted ? 'void(0)' : `openProofModal('${log.id}', '${quest.id}', '${cleanName}', ${quest.value})`;

                return `
                    <div class="app-card p-4 border ${isCompleted ? 'border-success' : 'border-primary/50'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="space-y-1 mb-2 sm:mb-0 max-w-full sm:max-w-[60%]">
                                <h4 class="text-lg font-bold text-text-light">${quest.name}</h4>
                                <p class="text-xs text-slate-400 italic break-words">${quest.description}</p>
                            </div>
                            <div class="flex flex-col space-y-2 w-full sm:w-auto mt-2 sm:mt-0">
                                <button 
                                    class="btn bg-slate-600 hover:bg-slate-700 text-white py-1 px-4 rounded-xl text-xs"
                                    onclick="showTaskGuide('${cleanName}', '${cleanDescription}', '${cleanInstructions}', '${cleanProof}')"
                                    >
                                    ❓ Guide
                                </button>
                                <button 
                                    class="btn py-2 px-4 rounded-xl text-sm font-semibold w-full sm:w-auto ${buttonClass}"
                                    ${isCompleted ? 'disabled' : ''}
                                    onclick="${action}"
                                >
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSkillsView() {
            const skillsListContainer = document.getElementById('player-skills-list');
            
            skillsListContainer.innerHTML = PLAYER_SKILLS.map(skill => {
                const canAfford = gameState.charXP >= skill.cost;
                const buttonClass = skill.unlocked ? 'bg-success/50 cursor-default' : (canAfford ? 'bg-secondary hover:bg-secondary/90' : 'bg-slate-600 cursor-not-allowed');
                const buttonText = skill.unlocked ? '✅ UNLOCKED' : (canAfford ? `Unlock for ${skill.cost} XP` : `${skill.cost} XP Required`);
                const action = skill.unlocked || !canAfford ? 'void(0)' : `unlockSkillAttempt('${skill.id}')`;
                const costText = skill.unlocked ? 'Permanent Skill' : `${skill.cost} XP`;

                return `
                    <div class="app-card p-4 border ${skill.unlocked ? 'border-success' : 'border-slate-500'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="space-y-1 mb-3 sm:mb-0 max-w-full sm:max-w-[70%]">
                                <h4 class="text-lg font-bold text-text-light">${skill.name} (${skill.type})</h4>
                                <p class="text-xs text-slate-400 italic">${skill.desc}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-2 w-full sm:w-auto">
                                <p class="text-sm font-semibold ${skill.unlocked ? 'text-success' : 'text-secondary'}">${costText}</p>
                                <button 
                                    class="btn py-2 px-4 rounded-xl text-sm font-semibold w-full sm:w-auto ${buttonClass}"
                                    ${skill.unlocked || !canAfford ? 'disabled' : ''}
                                    onclick="${action}"
                                >
                                    ${buttonText}
                                </button>
                                ${skill.unlocked ? `<p class="text-xs text-slate-400">Power Cost: ${skill.powerCost}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function unlockSkillAttempt(skillId) {
            const skill = PLAYER_SKILLS.find(s => s.id === skillId);
            
            if (!skill) return;

            if (skill.unlocked) {
                showGeneralModal('Already Learned', `${skill.name} is already part of your arsenal.`);
                return;
            }
            
            if (gameState.charXP < skill.cost) {
                showGeneralModal('XP Insufficient', `You need **${skill.cost} XP** to unlock ${skill.name}. Keep winning battles!`);
                return;
            }
            
            // Process unlock
            gameState.charXP -= skill.cost;
            
            if (unlockSkill(skillId)) { // This calls the function that updates the global PLAYER_SKILLS and saves localStorage
                saveCharacter(gameState); // Save new XP amount
                showGeneralModal('✨ Skill Unlocked!', `You successfully learned **${skill.cost} XP! You can now use it in the Impulse Battle Arena.`);
                // Log skill unlock event
                logDataToSheet({ charName: gameState.charName, skillId: skillId, skillName: skill.name }, 'Skills');
                updateUI(); // Re-render everything
            }
        }

        function openProofModal(logId, taskId, taskName, powerValue) {
            // Find the quest in the log's tasks to ensure it's still available
            const log = getLogById(logId);
            if (!log) return;
            const quest = log.tasks.find(t => t.id === taskId);
            if (!quest || quest.completed) return;
            
            proofTaskIdInput.value = taskId;
            document.getElementById('proof-battle-id').value = logId;
            proofTaskName.textContent = taskName;
            proofPowerReward.textContent = `Reward: +${powerValue} Power`;
            
            // Reset form fields
            proofTypeSelect.value = "";
            handleProofTypeChange(""); // Reset dynamic fields
            
            proofModal.classList.remove('hidden');
        }

        /**
         * FIX: Restructured to handle asynchronous file reading and prevent premature modal closure.
         * The modal is only closed after a successful submission (either sync text or async file).
         */
        function submitTaskProof(event) {
            event.preventDefault();
            
            const logId = document.getElementById('proof-battle-id').value;
            const taskId = proofTaskIdInput.value;
            const proofType = proofTypeSelect.value;
            
            // Reference to the submit button for disabling
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (!proofType) {
                 showGeneralModal('Validation Error', 'Please select a valid proof submission type first.');
                 return;
            }

            if (proofType === 'file') {
                const file = proofFileInput.files[0];
                if (!file) {
                    showGeneralModal('Validation Error', 'Please select a file proof to submit.');
                    return;
                }
                
                // Disable submit button temporarily
                if (submitButton) submitButton.disabled = true;

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Process submission ONLY after file reading is complete
                    processProofSubmission(logId, taskId, null, e.target.result, file.type.split('/')[0]);
                    
                    // Re-enable button and close modal after success
                    if (submitButton) submitButton.disabled = false;
                    closeProofModal();
                };
                reader.onerror = function() {
                     showGeneralModal('File Error', 'Could not read file. Please try a different file.');
                     // Re-enable button on error
                     if (submitButton) submitButton.disabled = false;
                };
                reader.readAsDataURL(file);

            } else if (proofType === 'text') {
                const textProof = proofTextarea.value.trim();
                if (!textProof) {
                    showGeneralModal('Validation Error', 'Please provide written proof to submit.');
                    return;
                }
                processProofSubmission(logId, taskId, textProof, null, 'text');
                closeProofModal(); // Safe to close immediately for sync task
            }
        }

        function processProofSubmission(logId, taskId, textProof, dataURL, type) {
             const logs = loadLogs();
             const logIndex = logs.findIndex(log => log.id === logId);

             if (logIndex !== -1) {
                 const log = logs[logIndex];
                 
                 // FIX: Find the quest in the log's tasks to get the correct value
                 const quest = log.tasks.find(t => t.id === taskId);
                 
                 // Update the specific task in the log
                 const taskIndex = log.tasks.findIndex(t => t.id === taskId);
                 if (taskIndex !== -1 && !log.tasks[taskIndex].completed) {
                     log.tasks[taskIndex].completed = true;
                     log.tasks[taskIndex].proofText = textProof || 'File proof submitted.';
                     // IMPORTANT: We temporarily include dataURL ONLY for immediate UI updates, but it is stripped in saveLog().
                     log.tasks[taskIndex].proofDataURL = dataURL; 
                     log.tasks[taskIndex].proofType = type;
                     log.currentPower += quest.value;

                     // Save and update UI
                     saveLog(log);
                     
                     // Log quest completion
                     logDataToSheet({ 
                         charName: gameState.charName, 
                         logId: logId, 
                         taskId: taskId, 
                         questName: quest.name, 
                         powerGained: quest.value, 
                         proofType: type 
                     }, 'Quests');

                     viewActiveBattle(logId);
                     showGeneralModal('💪 Power Gained!', `You gained **+${quest.value} Power** for completing the quest: ${quest.name}. Keep going!`);
                 }
             }
        }


        // --- Impulse Log Form Logic ---
        
        function setLogDateToToday() {
            const today = new Date().toISOString().split('T')[0];
            logDateInput.value = today;
            // Also reset form fields visually
            triggerForm.reset();
            logAfterFeelings.value = ''; // Ensure conditional fields are clear
            gaveInFields.classList.add('hidden');
            resistedFields.classList.remove('hidden');
        }

        function setupLogActionListeners() {
            // Attach event listener for Action Taken radio buttons
            const actionRadios = document.querySelectorAll('input[name="log-action"]');
            actionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const action = getRadioValue('log-action');
                    if (action === 'Gave In') {
                        gaveInFields.classList.remove('hidden');
                        logAfterFeelings.setAttribute('required', 'required');
                        resistedFields.classList.add('hidden');
                        logTriedInstead.removeAttribute('required');
                    } else {
                        gaveInFields.classList.add('hidden');
                        logAfterFeelings.removeAttribute('required');
                        logAfterFeelings.value = ''; // Clear input when hiding
                        resistedFields.classList.remove('hidden');
                        logTriedInstead.setAttribute('required', 'required');
                    }
                });
            });

            // Ensure the correct state is set on initial load/reset
            const initialAction = getRadioValue('log-action');
            if (initialAction === 'Gave In') {
                 gaveInFields.classList.remove('hidden');
                 resistedFields.classList.add('hidden');
            } else {
                 gaveInFields.classList.add('hidden');
                 resistedFields.classList.remove('hidden');
            }
        }

        triggerForm.onsubmit = function(event) {
            event.preventDefault();
            
            const triggerText = triggerSpecificInput.value.trim();
            if (!triggerText) {
                showMessage('Error', 'Please describe the Specific Trigger Event.', 'danger');
                return;
            }

            // 1. Get Trigger Type and Monster Data
            const { type } = getTriggerType(triggerText);
            const monsterProgress = loadProgress();
            const winCount = monsterProgress[type] ? monsterProgress[type].wins : 0;
            const monsterData = getMonsterByCount(type, winCount);
            
            // 2. Calculate tasks based on monster type, health, and tasks multiplier (tasksMultiplier=1.0 for new spawn)
            const dynamicTasks = calculateTasksForMonster(monsterData.health, type, monsterData.tasks_multiplier);


            // 3. Build the new Log Entry
            const logId = crypto.randomUUID();
            const logEntry = {
                id: logId,
                logDate: logDateInput.value,
                logTime: document.getElementById('log-time').value,
                triggerType: document.getElementById('trigger-type').value,
                triggerSpecific: triggerText,
                logEmotion: document.getElementById('log-emotion').value,
                logThoughts: document.getElementById('log-thoughts').value,
                actionTaken: getRadioValue('log-action'),
                afterFeelings: logAfterFeelings.value,
                triedInstead: logTriedInstead.value,

                // Monster / Battle Data
                monsterName: monsterData.name,
                monsterEmoji: monsterData.monsterEmoji, // Use the specific stage/type emoji
                monsterStage: monsterData.stage,
                monsterHealth: monsterData.health,
                monsterDefense: monsterData.defense || 0, // Default to 0 if not defined
                monsterSkills: monsterData.skills,
                currentPower: 0,
                status: 'Active', // Default status for new monster spawn
                tasks: dynamicTasks, // Use dynamically generated tasks
                
                // NEW: Track current HP (defaults to max HP on spawn)
                monsterCurrentHP: monsterData.health, 
                
                // For log entry tracking
                charName: gameState.charName,
            };
            
            // 4. Save Log and Update Game State
            saveLog(logEntry);
            gameState.activeLogId = logId; 
            gameState.dashboardView = 'battle'; // Switch view to battle immediately

            // 5. Clean up form and UI
            triggerForm.reset();
            setLogDateToToday();
            updateUI(); 
            
            // Show encounter modal
            showGeneralModal('🚨 Encounter Detected!', 
                `Your impulse has materialized as the **${monsterData.monsterEmoji} ${monsterData.name}**! (Stage ${monsterData.stage}).<br>Monster Health: **${monsterData.health}**. You have been assigned **${dynamicTasks.length} Quests** to gain power for the Battle Arena!`);
        };


        // --- Battle Arena Logic ---

        function appendArenaLog(message, isPlayer = true) {
            const color = isPlayer ? 'text-primary' : 'text-danger';
            arenaLog.innerHTML += `<p class="${color} text-xs">${message}</p>`;
            arenaLog.scrollTop = arenaLog.scrollHeight; // Auto-scroll
        }
        
        function updateArenaHPDisplay() {
            const playerMaxHP = gameState.charHP;
            const monsterMaxHP = battleArenaState.currentMonsterLog.monsterHealth;

            const playerPct = Math.max(0, (battleArenaState.playerCurrentHP / playerMaxHP) * 100);
            const monsterPct = Math.max(0, (battleArenaState.monsterCurrentHP / monsterMaxHP) * 100);

            arenaPlayerHpBar.style.width = `${playerPct}%`;
            arenaPlayerHpText.textContent = `HP: ${Math.max(0, battleArenaState.playerCurrentHP)} / ${playerMaxHP}`;
            
            arenaMonsterHpBar.style.width = `${monsterPct}%`;
            arenaMonsterHpText.textContent = `HP: ${Math.max(0, battleArenaState.monsterCurrentHP)} / ${monsterMaxHP}`;
        }
        
        function updateArenaControls() {
            const isPlayerTurn = battleArenaState.isPlayerTurn && !battleArenaState.isLocked;
            const log = battleArenaState.currentMonsterLog;
            const currentPower = log ? log.currentPower : 0;
            
            document.getElementById('arena-attack-btn').disabled = !isPlayerTurn;
            document.getElementById('arena-defend-btn').disabled = !isPlayerTurn;
            document.getElementById('arena-run-btn').disabled = !battleArenaState.isPlayerTurn; 

            // Render skills
            const skillButtons = [document.getElementById('arena-skill-1'), document.getElementById('arena-skill-2')];
            const unlockedSkills = PLAYER_SKILLS.filter(s => s.unlocked);

            skillButtons.forEach((btn, index) => {
                const skill = unlockedSkills[index];
                if (skill) {
                    const canUse = currentPower >= skill.powerCost;
                    btn.classList.remove('opacity-50');
                    btn.disabled = !isPlayerTurn || !canUse;
                    btn.textContent = `${skill.name} (${skill.powerCost} P)`;
                    btn.setAttribute('onclick', `playerTurn('${skill.id}')`);
                    
                    btn.classList.remove('skill-card', 'bg-primary', 'bg-success', 'bg-secondary');
                    
                    if (canUse) {
                        btn.classList.add(skill.type === 'Attack' ? 'bg-secondary' : skill.type === 'Heal' ? 'bg-success' : 'bg-primary');
                    } else {
                        btn.classList.add('bg-slate-600', 'opacity-50');
                    }
                } else {
                     btn.classList.add('opacity-50');
                     btn.disabled = true;
                     btn.textContent = `(Skill Slot ${index + 1} - Locked)`;
                     btn.removeAttribute('onclick');
                     btn.classList.add('skill-card');
                     btn.classList.remove('bg-secondary', 'bg-primary', 'bg-success');
                }
            });

            arenaMessage.textContent = battleArenaState.isLocked ? 'Sentinel is stunned! Turn skipped.' : (battleArenaState.isPlayerTurn ? 'Choose your next action!' : 'Monster is attacking...');
        }

        function launchTurnBasedBattle() {
            // CRITICAL FIX: Load the specific log entry using the activeLogId
            const activeLog = getLogById(gameState.activeLogId);
            if (!activeLog || activeLog.status !== 'Active') {
                 showGeneralModal('Error', 'No active monster selected, or monster has been defeated.', 'danger');
                 return;
            }
            
            // Initialize battle state
            battleArenaState.currentMonsterLog = activeLog;
            // NEW FEATURE: Use monsterCurrentHP (damaged HP) for battle start
            battleArenaState.monsterCurrentHP = activeLog.monsterCurrentHP; 
            // FIX: Player HP is reset to full (max HP) at the start of every battle
            battleArenaState.playerCurrentHP = gameState.charHP; 
            battleArenaState.isPlayerTurn = true;
            battleArenaState.isLocked = false;
            battleArenaState.playerDefending = false;
            battleArenaState.playerWillpowerModifier = 0;
            battleArenaState.playerFocusModifier = 0;
            
            // Render initial arena view
            arenaMonsterEmoji.textContent = activeLog.monsterEmoji;
            arenaMonsterName.textContent = activeLog.monsterName;
            arenaPlayerName.textContent = gameState.charName;
            arenaLog.innerHTML = '';
            
            updateArenaHPDisplay();

            appendArenaLog(`A wild ${activeLog.monsterName} (Stage ${activeLog.monsterStage}) appears!`, false);
            appendArenaLog(`Go, ${gameState.charName}!`);
            
            battleArenaModal.classList.remove('hidden');
            updateArenaControls();
        }

        function calculateDamage(baseStat, multiplier = 1, defense = 0, isPlayer = true) {
            const playerStat = isPlayer ? Math.max(1, baseStat + battleArenaState.playerWillpowerModifier + battleArenaState.playerFocusModifier) : baseStat;
            
            // Damage is based on a random number near the stat, minus opponent's defense
            const rawDamage = Math.max(1, Math.floor(Math.random() * playerStat * 1.5) + (playerStat * 0.5));
            let finalDamage = Math.max(1, rawDamage * multiplier - defense);
            
            // Monster Skill: Focus Block (Halve Damage)
            if (!isPlayer && battleArenaState.currentMonsterLog.monsterSkills.some(s => s.effect === 'Halve Damage')) {
                finalDamage = Math.round(finalDamage / 2);
            }

            // NEW FEATURE: Power Scaling for Player Attack (Applied during all attacks)
            if (isPlayer && battleArenaState.currentMonsterLog) {
                const log = battleArenaState.currentMonsterLog;
                const powerRatio = log.currentPower / log.monsterHealth;
                let powerBonus = 0;

                // Adjust multiplier based on how much extra power the player has
                if (powerRatio > 1.0) {
                    // Bonus damage is proportional to the excess power percentage (e.g., 10% bonus damage per 100% excess power)
                    powerBonus = (powerRatio - 1.0) * 0.5; // Example: 200 power vs 100 HP gives 1.0 excess power, resulting in +50% damage.
                    
                    // Apply this bonus to the existing multiplier
                    finalDamage = Math.round(finalDamage * (multiplier + powerBonus));

                    if (powerBonus >= 1.0) {
                         appendArenaLog('*** ABSOLUTE RUTHLESS ATTACK! (Damage x2.0+) ***', true);
                    } else if (powerBonus >= 0.5) {
                         appendArenaLog('** OVERCHARGED ATTACK! **', true);
                    } else if (powerBonus > 0) {
                         appendArenaLog('* Focused Power Bonus! *', true);
                    }
                } else {
                     finalDamage = Math.round(finalDamage * multiplier); // Normal damage if power < health
                }
            }
            
            return Math.round(finalDamage);
        }

        function playerTurn(action) {
            if (!battleArenaState.isPlayerTurn || battleArenaState.isLocked) return;
            
            const log = battleArenaState.currentMonsterLog;
            const playerTotalStat = gameState.charWillpower + gameState.charFocus;
            
            let damage = 0;
            let message = '';
            let skipMonsterTurn = false;
            let powerUsed = 0;
            
            // Reset temporary modifiers (Defense is only for 1 turn)
            battleArenaState.playerDefending = false;

            // --- Strategy: Player Actions ---
            if (action === 'Attack') {
                // Multiplier set to 1 to allow calculateDamage to apply the Power Scaling logic
                damage = calculateDamage(playerTotalStat, 1, log.monsterDefense || 0, true); 
                message = `${gameState.charName} launched a standard **Focus Attack**!`;

            } else if (action === 'Defend') {
                battleArenaState.playerDefending = true;
                message = `${gameState.charName} braced with **Willpower Defend**! Defense is boosted.`;
            
            } else {
                 const skill = PLAYER_SKILLS.find(s => s.id === action);
                 if (skill && skill.unlocked) {
                    if (log.currentPower < skill.powerCost) {
                        appendArenaLog(`You need ${skill.powerCost} Power to use ${skill.name}!`, true);
                        return; // Block skill use if power is insufficient
                    }
                    powerUsed = skill.powerCost;

                    // Skill Logic
                    if (skill.id === 'thought_record') {
                         // Note: Skill damage overrides basic attack and uses its own multiplier
                         damage = calculateDamage(playerTotalStat, 1.2, log.monsterDefense || 0, true); // +20% damage
                         battleArenaState.isLocked = false; // Cures LOCK
                         message = `Sentinel used **${skill.name}**! Critical thoughts are cleared, and it dealt ${damage} damage.`;
                    } else if (skill.id === 'mindfulness_shield') {
                         battleArenaState.playerDefending = true;
                         message = `Sentinel raised a **${skill.name}**! Defense is now razor sharp.`;
                    } else if (skill.id === 'delay_gratification') {
                         battleArenaState.playerCurrentHP = Math.min(gameState.charHP, battleArenaState.playerCurrentHP + 10);
                         skipMonsterTurn = true; // Delays Monster turn
                         message = `Sentinel practiced **${skill.name}**, gaining 10 HP. Monster is confused and skips a turn.`;
                    } else if (skill.id === 'support_call') {
                         damage = 10;
                         battleArenaState.playerCurrentHP = Math.min(gameState.charHP, battleArenaState.playerCurrentHP + 30);
                         message = `Sentinel called for **${skill.name}**! Gained 30 HP and a minor attack.`;
                    }
                 }
            }
            
            // Deduct Power Cost
            if (powerUsed > 0) {
                 log.currentPower = Math.max(0, log.currentPower - powerUsed);
                 saveLog(log); // Persist the power deduction
                 appendArenaLog(`-${powerUsed} Power used. Remaining: ${log.currentPower}`, true);
            }


            // Apply Damage
            if (damage > 0) {
                 battleArenaState.monsterCurrentHP -= damage;
                 appendArenaLog(`It dealt **${damage}** damage to ${log.monsterName}!`, true);
            }
            
            updateArenaHPDisplay();
            checkBattleEnd();

            if (battleArenaState.monsterCurrentHP > 0 && !skipMonsterTurn) {
                battleArenaState.isPlayerTurn = false;
                arenaAttackBtn.disabled = true;
                arenaMessage.textContent = 'Monster is preparing its attack...';
                setTimeout(monsterTurn, 1500); // Monster attacks after 1.5s delay
            } else if (skipMonsterTurn && battleArenaState.monsterCurrentHP > 0) {
                 battleArenaState.isPlayerTurn = true; // Player gets another turn
                 updateArenaControls();
            }
        }
        
        function monsterTurn() {
            if (battleArenaState.monsterCurrentHP <= 0) return; 
            
            const log = battleArenaState.currentMonsterLog;
            const skills = log.monsterSkills;
            
            const skillIndex = Math.floor(Math.random() * skills.length);
            const skill = skills[skillIndex];
            
            let damage = skill.damage;
            let message = `${log.monsterName} used **${skill.name}**!`;
            
            // Calculate effective defense
            // Defend action gives 2x base defense; otherwise, just use base defense.
            const playerEffectiveDefense = gameState.charDefense + (battleArenaState.playerDefending ? gameState.charDefense * 2 : 0);
            
            // Apply damage or effect
            if (skill.damage > 0) {
                let finalDamage = Math.max(1, damage - playerEffectiveDefense);
                
                // Skill: Temporal Loop (Double Attack)
                if (skill.effect.includes('Double Attack')) {
                     finalDamage *= 2;
                }
                
                battleArenaState.playerCurrentHP -= finalDamage;
                message += ` It hit ${gameState.charName} for **${finalDamage}** HP!`;
            }

            // Handle specific effects (Debuffs)
            if (skill.effect.includes('Lower Focus')) {
                battleArenaState.playerFocusModifier -= 2;
            } else if (skill.effect.includes('Lower Willpower')) {
                battleArenaState.playerWillpowerModifier -= 2;
            } else if (skill.effect.includes('Lock')) {
                battleArenaState.isLocked = true;
                message += ` ${gameState.charName} is stunned (LOCKED)!`;
            }
            
            appendArenaLog(message, false);
            updateArenaHPDisplay();
            checkBattleEnd();

            if (battleArenaState.playerCurrentHP > 0) {
                battleArenaState.isPlayerTurn = true;
                updateArenaControls();
            }
        }

        function checkBattleEnd() {
            if (battleArenaState.monsterCurrentHP <= 0) {
                endBattle(true);
            } else if (battleArenaState.playerCurrentHP <= 0) {
                endBattle(false);
            }
        }

        function endBattle(isVictory) {
            // Note: proofTextarea can be null if the function is called before initGame completes
            if(proofTextarea) {
                 proofTextarea.removeEventListener('input', handleProofTextareaInput);
            }
            
            // Safely close modal without relying on the specific element
            battleArenaModal.classList.add('hidden');
            
            if (battleArenaState.currentMonsterLog) {
                 showAttackResult(battleArenaState.currentMonsterLog.id, isVictory);
            } else {
                 // Should not happen, but safe fallback
                 changeDashboardView('battle');
            }
        }

        function showAttackResult(logId, isVictory) {
            // Must reload logs to get the current state
            const logs = loadLogs();
            const logIndex = logs.findIndex(log => log.id === logId);
            if (logIndex === -1) return;
            
            const log = logs[logIndex];
            const logTriggerType = log.triggerType;
            const monsterType = getTriggerType(log.triggerSpecific).type;
            const monsterData = getMonsterByCount(monsterType, log.monsterStage - 1); // Get config for the stage that was fought
            let xpReward = isVictory ? log.monsterHealth * 2 : 0;
            
            // Update global progression (win count)
            const monsterProgress = loadProgress();
            monsterProgress[monsterType] = monsterProgress[monsterType] || { wins: 0, defeats: 0 };

            if (isVictory) {
                log.status = 'Defeated';
                log.monsterCurrentHP = 0; // Final kill health
                monsterProgress[monsterType].wins++;
                showGeneralModal('🎉 VICTORY!', `You successfully defeated the **${log.monsterName}**! You earned **+${xpReward} XP** and fortified your defense.`);
                // XP and Stats Gain
                gameState.charXP += xpReward;
                gameState.charDefense = Math.min(15, gameState.charDefense + 1); // Minor permanent defense gain
                
                // Log battle result
                logDataToSheet({ charName: gameState.charName, logId: logId, monsterName: log.monsterName, result: 'Victory', xpGained: xpReward, newDefense: gameState.charDefense }, 'Battles');
            } else {
                // NEW FEATURE: Save the damage dealt (remaining HP)
                log.monsterCurrentHP = Math.max(0, battleArenaState.monsterCurrentHP); 
                
                // NEW FEATURE: Defeat resets power AND generates new tasks based on factor
                log.status = 'Active'; // Keep active to allow rematch
                log.currentPower = 0; // Power reset
                
                monsterProgress[monsterType].defeats++; 

                // --- ADJUSTED DIFFICULTY: Quests are NO LONGER 2.0X MORE DIFFICULT on defeat ---
                // We keep the multiplier at 1.0x to avoid making recovery too punitive.
                const tasksMultiplierOnDefeat = 1.0; 
                
                // Generate new tasks based on the defeat multiplier
                log.tasks = calculateTasksForMonster(log.monsterHealth, logTriggerType, tasksMultiplierOnDefeat);

                showGeneralModal('😭 DEFEAT!', 
                    `The **${log.monsterEmoji} ${log.monsterName}** was too strong. **Your damage dealt persists!** But your Power has been reset to 0. **${log.tasks.length} New Quests** have been assigned to fortify your Willpower before a rematch!`);
                
                // Log battle result
                logDataToSheet({ charName: gameState.charName, logId: logId, monsterName: log.monsterName, result: 'Defeat', xpGained: 0, newDefense: gameState.charDefense }, 'Battles');
            }

            saveProgress(monsterProgress);
            saveLog(log);
            saveCharacter(gameState);
            
            // NEW FEATURE: Check for level up after XP gain
            checkLevelUp();

            // CRITICAL FIX: Reset activeLogId to null to view the list of all active encounters.
            gameState.activeLogId = null;
            changeDashboardView('battle'); 
        }

        
        // --- Settings View Logic ---
        
        function toggleSettingsEdit(enable) {
            // Include ALL fields, including Real Name and Phone
            const allSettingsFields = [
                settingsRealNameInput, settingsPhoneInput, settingsNameInput, settingsAgeInput, 
                settingsCityInput, settingsSourceInput, settingsFaithSelect, settingsWillpowerInput, 
                settingsFocusInput, settingsPurposeTextarea
            ];
            
            // Get references to buttons
            const editBtn = document.getElementById('edit-profile-btn');
            const saveBtn = document.getElementById('settings-save-btn');
            const cancelBtn = document.getElementById('settings-cancel-btn');
            
            // 1. Toggle field disabled state and opacity/cursor style
            allSettingsFields.forEach(field => {
                field.disabled = !enable;
                // Remove opacity/cursor styling when editing is ENABLED
                field.classList.toggle('opacity-70', !enable);
                field.classList.toggle('cursor-not-allowed', !enable);
            });

            // 2. Toggle buttons visibility and state
            editBtn.classList.toggle('hidden', enable);
            saveBtn.classList.toggle('hidden', !enable);
            cancelBtn.classList.toggle('hidden', !enable);

            if (!enable) {
                // If canceling (enable=false), reset the editable fields to the last saved state (gameState)
                // We re-call renderSettingsView with skipDisable=true to refresh values without creating recursion
                renderSettingsView(true);
            }
        }


        function renderSettingsView(skipDisable = false) {
            // Pre-fill the form with current character data
            // Private details
            settingsRealNameInput.value = gameState.charRealName; 
            settingsPhoneInput.value = gameState.charPhone;
            
            // Editable Warrior/Public Details
            settingsNameInput.value = gameState.charName;
            settingsCityInput.value = gameState.charCity; 
            settingsSourceInput.value = gameState.charSource; 
            settingsAgeInput.value = gameState.charAge || '';
            settingsFaithSelect.value = gameState.charSpecial === 'Inner Light' ? 'yes' : 'no';
            settingsWillpowerInput.value = gameState.charWillpower;
            settingsFocusInput.value = gameState.charFocus;
            settingsPurposeTextarea.value = gameState.charPurpose;
            
            // Must manually update outputs here after setting slider value
            document.getElementById('willpower-output').value = gameState.charWillpower;
            document.getElementById('focus-output').value = gameState.charFocus;

            if (!skipDisable) {
                // Ensure inputs are disabled initially when viewing the settings
                toggleSettingsEdit(false); 
            }
        }
        
        // Settings Form Submission Handler (Save)
        settingsForm.onsubmit = function(event) {
            event.preventDefault();
            
            // Check if form is actually enabled (edit mode)
            if (settingsNameInput.disabled) return;
            
            // Perform basic validation before saving
            if (!/^\d*$/.test(settingsPhoneInput.value)) {
                 showGeneralModal('Validation Error', 'Phone number must contain only digits.', 'danger');
                 return;
            }

            // Update all fields, including the private ones now that they are accessible
            gameState.charRealName = settingsRealNameInput.value.trim();
            gameState.charPhone = settingsPhoneInput.value.trim();
            gameState.charName = settingsNameInput.value.trim();
            gameState.charCity = settingsCityInput.value.trim(); 
            gameState.charSource = settingsSourceInput.value.trim(); 
            gameState.charAge = parseInt(settingsAgeInput.value) || 0;
            gameState.charWillpower = parseInt(settingsWillpowerInput.value);
            gameState.charFocus = parseInt(settingsFocusInput.value);
            gameState.charPurpose = settingsPurposeTextarea.value.trim();
            
            // Handle faith/special attribute update
            const newFaith = settingsFaithSelect.value;
            gameState.charSpecial = newFaith === 'yes' ? 'Inner Light' : 'None';

            // Re-apply stat clamping 
            gameState.charWillpower = Math.min(10, Math.max(1, gameState.charWillpower));
            gameState.charFocus = Math.min(10, Math.max(1, gameState.charFocus));
            
            saveCharacter(gameState);
            
            // Disable inputs after successful save
            toggleSettingsEdit(false);
            
            updateUI();
            showGeneralModal('Profile Updated', 'Your Sentinel profile details have been successfully saved!');
        };
        
        function renderGuideView() {
            // The content is static HTML and only needs to be made visible
        }

        
        // --- Splash Screen & Initialization ---
        
        // CRITICAL FIX: Hide the body immediately, show the app after the splash screen.
        document.body.classList.add('hidden-init');
        splashScreen.classList.remove('hidden-init'); // Ensure splash is visible

        function initGame() {
            const characterData = loadCharacter();
            if (characterData) {
                gameState = { ...INITIAL_STATE, ...characterData };
                gameState.phase = 'input';
                gameState.dashboardView = 'log'; 
                
                // We only ensure the battle view is the default view if there ARE active monsters.
                const activeMonsters = loadLogs().filter(log => log.status === 'Active');
                if (activeMonsters.length > 0) {
                    gameState.dashboardView = 'battle';
                }

                showMessage(`Welcome back, Warrior ${characterData.charName}! Log your next impulse.`, 'info');
            } else {
                gameState.phase = 'creation';
                showMessage('Welcome! Please create your character to begin your journey.', 'info');
            }
            // Must load skills after setting initial state
            loadSkills();
            
            // Attach the input listener here, AFTER DOM elements are defined
            if(proofTextarea) {
                proofTextarea.addEventListener('input', handleProofTextareaInput);
            }

            updateUI();
        }

        function handleSplash() {
             // Delay to allow external assets (Tailwind) to load before calculating load time
             setTimeout(() => {
                splashScreen.classList.add('fade-out');
                // Hides splash and shows body after CSS transition is complete (1s)
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    document.body.classList.remove('hidden-init'); 
                    initGame();
                }, 1000); 
            }, 100); // Small initial delay
        }
        
        // Character Submission Handler
        characterForm.onsubmit = function(event) {
            event.preventDefault();
            
            // --- CRITICAL FIX: Change validation check to break and show error if any step fails ---
            let allStepsValid = true;
            for (let i = 1; i <= stepElements.length; i++) {
                if (!validateStep(i)) {
                    // Navigate to the failed step and show the error message.
                    currentStepInput.value = i;
                    updateCreationStepUI();
                    showMessage('Please complete all required fields on the current and previous steps.', 'danger');
                    allStepsValid = false;
                    break;
                }
            }

            if (!allStepsValid) return;
            // --- END CRITICAL FIX ---

            const formData = {
                realName: document.getElementById('char-real-name').value, 
                city: document.getElementById('char-city').value, 
                source: document.getElementById('char-source').value, 
                phone: document.getElementById('char-phone').value, // NEW
                name: document.getElementById('char-name').value,
                age: parseInt(document.getElementById('char-age').value) || 0,
                willpower: document.getElementById('char-willpower').value,
                focus: document.getElementById('char-focus').value,
                faith: document.getElementById('char-faith').value,
                purpose: document.getElementById('char-purpose').value,
                quitCount: document.getElementById('char-quit-count').value, // Use value directly from select
                
                // Get checked checkbox values
                triggers: Array.from(document.querySelectorAll('input[name="char-trigger"]:checked')).map(el => el.value),
                motives: Array.from(document.querySelectorAll('input[name="char-motive"]:checked')).map(el => el.value)
            };

            // Calculate final stats and transition to dashboard
            const calculatedStats = calculateBaseStats(formData);
            gameState = { ...INITIAL_STATE, ...calculatedStats, phase: 'input', dashboardView: 'log' };
            saveCharacter(gameState); 
            
            // This is the critical final step: switching the view
            updateUI();
            
            // Log the new character creation to the sheet
            logDataToSheet(gameState, 'ProfileCreation');

            // NEW: Prompt the user to check the guide immediately after creation
            showGeneralModal('Sentinel Created!', 
                `Sentinel ${gameState.charName} created! Your initial HP: ${gameState.charHP}.
                 <br><br>
                 **The Mystery Man** has a guide for you. Navigate to the **❓ Guide** tab now to learn how to play!`);
        };

        // Proof Submission Handler
        proofForm.onsubmit = submitTaskProof;

        // UI Update Loop
        function updateUI() {
            loadSkills(); 
            
            charCreationSection.classList.add('hidden');
            triggerSection.classList.add('hidden');
            logViewContainer.classList.add('hidden');
            battleQuestContainer.classList.add('hidden');
            skillsViewContainer.classList.add('hidden'); 
            settingsViewContainer.classList.add('hidden'); 
            guideViewContainer.classList.add('hidden'); 
            
            messageBox.classList.add('hidden');
            resetButton.classList.add('hidden');

            if (gameState.phase === 'creation') {
                charCreationSection.classList.remove('hidden');
                updateCreationStepUI();
            } else {
                triggerSection.classList.remove('hidden');
                renderDashboard();
                
                // Update nav button classes
                const navButtons = [navLogBtn, navBattleBtn, navSkillsBtn, navGuideBtn, navSettingsBtn]; 
                navButtons.forEach(btn => btn.classList.remove('bg-primary', 'bg-slate-600'));
                
                
                const view = gameState.dashboardView;
                const activeNavBtn = document.getElementById(`nav-${view}`);
                if (activeNavBtn) {
                    activeNavBtn.classList.add('bg-primary');
                    navButtons.filter(btn => btn !== activeNavBtn).forEach(btn => btn.classList.add('bg-slate-600'));
                } else {
                    // Default to log view if state is corrupt
                    navLogBtn.classList.add('bg-primary');
                    navBattleBtn.classList.add('bg-slate-600');
                    navSkillsBtn.classList.add('bg-slate-600');
                    navGuideBtn.classList.add('bg-slate-600');
                    navSettingsBtn.classList.add('bg-slate-600');
                }


                if (view === 'log') {
                    logViewContainer.classList.remove('hidden');
                    filterLogHistory(); 
                } else if (view === 'battle') {
                    battleQuestContainer.classList.remove('hidden');
                     
                    if (gameState.activeLogId) {
                        activeBattleView.classList.remove('hidden');
                        battleLogList.classList.add('hidden');
                        document.getElementById('encounter-history-list').classList.add('hidden');
                        renderBattleState(); 
                    } else {
                        activeBattleView.classList.add('hidden');
                        battleLogList.classList.remove('hidden');
                        document.getElementById('encounter-history-list').classList.remove('hidden');
                        renderBattleLogList(); 
                        renderMonsterHistory();
                    }
                } else if (view === 'skills') {
                    skillsViewContainer.classList.remove('hidden');
                    renderSkillsView();
                } else if (view === 'settings') { 
                    settingsViewContainer.classList.remove('hidden');
                    renderSettingsView();
                } else if (view === 'guide') { 
                    guideViewContainer.classList.remove('hidden');
                    renderGuideView();
                }
                
                if (gameState.phase === 'input') {
                    setLogDateToToday();
                    setupLogActionListeners();
                }
            }
        }
        
        // --- Proof Image/Text Preview Handlers ---

        function previewProofImage(event) {
            const file = event.target.files[0];
            proofPreview.innerHTML = 'File selected...'; 
            
            if (file) {
                const fileType = file.type;
                if (fileType.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        proofPreview.innerHTML = `<img src="${e.target.result}" alt="Proof Image Preview">`;
                    };
                    reader.readAsDataURL(file);
                } else if (fileType.startsWith('video/')) {
                     proofPreview.innerHTML = `<video src="${URL.createObjectURL(file)}" controls muted></video>`;
                } else if (fileType.startsWith('audio/')) {
                    proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm"><span class="text-primary">🎤 Voice/Audio Recording</span><audio src="${URL.createObjectURL(file)}" controls class="w-full mt-2"></audio></div>`;
                } else {
                    proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm text-center"><span class="text-primary">📄 Document/Text File Selected</span><br>Filename: ${file.name}</div>`;
                }
                proofTextarea.value = '';
            } else {
                proofPreview.innerHTML = 'Upload your file...';
            }
        }
        
        function handleProofTextareaInput() {
             if (proofTextarea.value.trim() !== '') {
                proofFileInput.value = '';
                proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm text-center"><span class="text-primary">📝 Text Proof Entered</span></div>`;
            } else {
                 proofPreview.innerHTML = 'Upload your file...';
            }
        }


        // Initialize UI on load
        window.onload = handleSplash;

    </script>
</body>
</html>
